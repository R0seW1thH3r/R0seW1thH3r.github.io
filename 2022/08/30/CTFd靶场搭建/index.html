<!DOCTYPE html>
<html lang="zh-CN">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">

  
  <title>CTFd动态靶机搭建</title>
  
  <link rel="canonical" href="https://ja1e.github.io/2022/08/30/CTFd%E9%9D%B6%E5%9C%BA%E6%90%AD%E5%BB%BA/">
  
  <meta name="description" content="基于docker搭建支持动态靶机的靶场每做一道题，就会自动生成一个虚拟题目环境，每一个环境刚刚生成的时候都是崭新的。 我的环境 主机：腾讯云的轻量服务器CentOS7.6-Docker20 Docker版本：20.10.17 Docker-compose版本：20.10.17 IP地址：公网地址  ">
  
  
  <meta name="author" content="Ja1e">
  
  
  
  <meta property="og:site_name" content="Ja1e" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="CTFd动态靶机搭建" />
  
  <meta property="og:description" content="基于docker搭建支持动态靶机的靶场每做一道题，就会自动生成一个虚拟题目环境，每一个环境刚刚生成的时候都是崭新的。 我的环境 主机：腾讯云的轻量服务器CentOS7.6-Docker20 Docker版本：20.10.17 Docker-compose版本：20.10.17 IP地址：公网地址  ">
  
  <meta property="og:url" content="https://ja1e.github.io/2022/08/30/CTFd%E9%9D%B6%E5%9C%BA%E6%90%AD%E5%BB%BA/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="CTFd动态靶机搭建">
  
  <meta name="twitter:description" content="基于docker搭建支持动态靶机的靶场每做一道题，就会自动生成一个虚拟题目环境，每一个环境刚刚生成的时候都是崭新的。 我的环境 主机：腾讯云的轻量服务器CentOS7.6-Docker20 Docker版本：20.10.17 Docker-compose版本：20.10.17 IP地址：公网地址  ">
  
  
  
  
  <meta name="twitter:url" content="https://ja1e.github.io/2022/08/30/CTFd%E9%9D%B6%E5%9C%BA%E6%90%AD%E5%BB%BA/" />

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="preload" href="/fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  
  
<link rel="stylesheet" href="/css/user.css">

  

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

  <!-- Custom Theme Color Style
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  

  
  <script src="/js/pic.min.js" defer></script>
  

  

<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn">🌑</div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden>☀️</div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

  <div class="six columns ml-1">
    <h1 class="mt-2">
      Hi Folks.
    </h1>
  </div>

  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        <a href="/">Home</a>
        
          
          <a href="/tags" class="ml">Tags</a>
          
        
          
          <a href="/about" class="ml">About</a>
          
        
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>
<link rel="stylesheet" href="/js/prism/prism.css">
        <div class="trans">
            <h2>CTFd动态靶机搭建</h2>

  <h1 id="基于docker搭建支持动态靶机的靶场"><a href="#基于docker搭建支持动态靶机的靶场" class="headerlink" title="基于docker搭建支持动态靶机的靶场"></a>基于docker搭建支持动态靶机的靶场</h1><p>每做一道题，就会自动生成一个虚拟题目环境，每一个环境刚刚生成的时候都是崭新的。</p>
<h2 id="我的环境"><a href="#我的环境" class="headerlink" title="我的环境"></a>我的环境</h2><ul>
<li>主机：腾讯云的轻量服务器CentOS7.6-Docker20</li>
<li>Docker版本：20.10.17</li>
<li>Docker-compose版本：20.10.17</li>
<li>IP地址：公网地址</li>
</ul>
<p>然后就完全按照这个链接上的做🧎🧎🧎：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/docs/share/364ef08c-9405-45fe-b269-e9236de57242#OE1rs">https://www.yuque.com/docs/share/364ef08c-9405-45fe-b269-e9236de57242?#OE1rs</a></li>
</ul>
<p>成果：</p>
<p><img src="/images/ctfd.png" alt="ctfd"></p>
<h2 id="系统环境搭建配置"><a href="#系统环境搭建配置" class="headerlink" title="系统环境搭建配置"></a>系统环境搭建配置</h2><p>更新yum源，和安装系统环境所需服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum update
yum <span class="token function">install</span> -y <span class="token function">git</span> nginx mariadb mariadb-server Mysql-python python-pip gcc  python-devel yum-utils device-mapper-persistent-data lvm2 epel-release<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>因为我的vps自带了docker，就不安装了。</p>
<h2 id="靶场环境"><a href="#靶场环境" class="headerlink" title="靶场环境"></a>靶场环境</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~
<span class="token function">git</span> clone https://github.com/glzjin/CTFd.git
<span class="token function">wget</span> https://github.com/fatedier/frp/releases/download/v0.29.0/frp_0.29.0_linux_amd64.tar.gz
<span class="token function">tar</span> -zxvf frp_0.29.0_linux_amd64.tar.gz
<span class="token function">git</span> clone https://github.com/glzjin/CTFd-Whale.git
<span class="token function">mv</span> CTFd-Whale/ ctfd-whale
<span class="token function">git</span> clone https://github.com/glzjin/Frp-Docker-For-CTFd-Whale
<span class="token function">mv</span> Frp-Docker-For-CTFd-Whale/ frp-docker-for-ctfd-whale
<span class="token function">docker</span> swarm init
<span class="token function">docker</span> <span class="token function">node</span> update --label-add<span class="token operator">=</span><span class="token string">'name=linux-1'</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span> -q<span class="token variable">)</span></span>
<span class="token function">mv</span> ctfd-whale/ CTFd/CTFd/plugins/
<span class="token builtin class-name">cd</span> frp-docker-for-ctfd-whale
<span class="token function">docker-compose</span> up -d
<span class="token builtin class-name">cd</span> ~/CTFd
<span class="token function">mkdir</span> frpc
<span class="token builtin class-name">cd</span> ~/frp_0.29.0_linux_amd64
<span class="token function">mv</span> frpc.ini <span class="token punctuation">..</span>/CTFd/frpc/
<span class="token function">mv</span> frpc_full.ini <span class="token punctuation">..</span>/CTFd/frpc/
<span class="token function">mv</span> frpc <span class="token punctuation">..</span>/CTFd/frpc/
<span class="token function">mv</span> LICENSE <span class="token punctuation">..</span>/CTFd/frpc/
<span class="token builtin class-name">cd</span> ~/CTFd/frpc
<span class="token function">vim</span> frpc.ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>frpc.ini的内容修改如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
token <span class="token operator">=</span> randomme
server_addr <span class="token operator">=</span> <span class="token number">172.1</span>.0.4
server_port <span class="token operator">=</span> <span class="token number">6490</span>
pool_count <span class="token operator">=</span> <span class="token number">200</span>
tls_enable <span class="token operator">=</span> <span class="token boolean">true</span>

admin_addr <span class="token operator">=</span> <span class="token number">172.1</span>.0.3
admin_port <span class="token operator">=</span> <span class="token number">7400</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/CTFd
<span class="token function">vim</span> Dockerfile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Dockerfile的内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FROM python:3.6-alpine
RUN <span class="token function">sed</span> -i <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories <span class="token operator">&amp;&amp;</span><span class="token punctuation">\</span>
    apk update <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
    apk <span class="token function">add</span> python3 python3-dev linux-headers libffi-dev gcc <span class="token function">make</span> musl-dev py-pip mysql-client <span class="token function">git</span> openssl-dev g++
RUN adduser -D -u <span class="token number">1001</span> -s /bin/bash ctfd
WORKDIR /opt/CTFd
RUN <span class="token function">mkdir</span> -p /opt/CTFd /var/log/CTFd /var/uploads
RUN pip3 config <span class="token builtin class-name">set</span> global.index-url https://pypi.doubanio.com/simple
RUN pip3 config <span class="token builtin class-name">set</span> install.trusted-host pypi.doubanio.com
COPY requirements.txt <span class="token builtin class-name">.</span>
RUN pip <span class="token function">install</span> -r requirements.txt -i  https://pypi.doubanio.com/simple
COPY <span class="token builtin class-name">.</span> /opt/CTFd
RUN <span class="token keyword">for</span> <span class="token for-or-select variable">d</span> <span class="token keyword">in</span> CTFd/plugins/*<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token punctuation">\</span>
      <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token string">"<span class="token variable">$d</span>/requirements.txt"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token punctuation">\</span>
        pip <span class="token function">install</span> -r <span class="token variable">$d</span>/requirements.txt -i  https://pypi.doubanio.com/simple<span class="token punctuation">;</span> <span class="token punctuation">\</span>
      <span class="token keyword">fi</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
    <span class="token keyword">done</span><span class="token punctuation">;</span>
RUN <span class="token function">chmod</span> +x /opt/CTFd/docker-entrypoint.sh
RUN <span class="token function">chown</span> -R <span class="token number">1001</span>:1001 /opt/CTFd
RUN <span class="token function">chown</span> -R <span class="token number">1001</span>:1001 /var/log/CTFd /var/uploads
<span class="token environment constant">USER</span> <span class="token number">1001</span>
EXPOSE <span class="token number">8000</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"/opt/CTFd/docker-entrypoint.sh"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> docker-compose.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>docker-compose.yml的内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">version: <span class="token string">'2.2'</span>

services:
  ctfd-nginx:
    image: nginx:1.17
    volumes:
      - ./nginx/http.conf:/etc/nginx/nginx.conf   
    user: root
    restart: always
    ports:    
      - <span class="token string">"443:443"</span>
    networks:
        default:
        internal:
    depends_on:
      - ctfd
    cpus: <span class="token string">'1.00'</span>  
    mem_limit: 150M     
  ctfd:
    build: <span class="token builtin class-name">.</span>
    user: root
    restart: always
    ports:
      - <span class="token string">"8000:8000"</span>     
    environment:
      - <span class="token assign-left variable">UPLOAD_FOLDER</span><span class="token operator">=</span>/var/uploads
      - <span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span>mysql+pymysql://root:ctfd@db/ctfd
      - <span class="token assign-left variable">REDIS_URL</span><span class="token operator">=</span>redis://cache:6379
      - <span class="token assign-left variable">WORKERS</span><span class="token operator">=</span><span class="token number">1</span>
      - <span class="token assign-left variable">LOG_FOLDER</span><span class="token operator">=</span>/var/log/CTFd
      - <span class="token assign-left variable">ACCESS_LOG</span><span class="token operator">=</span>-
      - <span class="token assign-left variable">ERROR_LOG</span><span class="token operator">=</span>-
      - <span class="token assign-left variable">REVERSE_PROXY</span><span class="token operator">=</span>true
    volumes:
      - .data/CTFd/logs:/var/log/CTFd
      - .data/CTFd/uploads:/var/uploads
      - .:/opt/CTFd:ro
      - /var/run/docker.sock:/var/run/docker.sock     
    depends_on:
      - db
    networks:
        default:
        internal:
        frp:
            ipv4_address: <span class="token number">172.1</span>.0.2
    cpus: <span class="token string">'1.00'</span>     
    mem_limit: 450M     

  db:
    image: mariadb:10.4
    restart: always
    environment:
      - <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>ctfd
      - <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>ctfd
      - <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span>ctfd
    volumes:
      - .data/mysql:/var/lib/mysql
    networks:
        internal:
    command: <span class="token punctuation">[</span>mysqld, --character-set-server<span class="token operator">=</span>utf8mb4, --collation-server<span class="token operator">=</span>utf8mb4_unicode_ci, --wait_timeout<span class="token operator">=</span><span class="token number">28800</span>, --log-warnings<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span>
    cpus: <span class="token string">'1.00'</span>     
    mem_limit: 750M     

  cache:
    image: redis:4
    restart: always
    volumes:
      - .data/redis:/data
    networks:
        internal:
    cpus: <span class="token string">'1.00'</span>     
    mem_limit: 450M     

  frpc:    
    image: glzjin/frp:latest     
    restart: always
    volumes:
      - ./frpc:/conf/     
    entrypoint:
        - /usr/local/bin/frpc
        - -c
        - /conf/frpc.ini
    networks:
        frp:
            ipv4_address: <span class="token number">172.1</span>.0.3  
        frp-containers:
    cpus: <span class="token string">'1.00'</span>     
    mem_limit: 250M     

networks:
    default:
    internal:
        internal: <span class="token boolean">true</span>
    frp:
        driver: bridge
        ipam:
            config:
                - subnet: <span class="token number">172.1</span>.0.0/16
    frp-containers:
        driver: overlay
        internal: <span class="token boolean">true</span>
        ipam:
            config:
                - subnet: <span class="token number">172.2</span>.0.0/16


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>requirements.txt的内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">Flask</span><span class="token operator">==</span><span class="token number">1.1</span>.1
<span class="token assign-left variable">Werkzeug</span><span class="token operator">==</span><span class="token number">0.16</span>.0
Flask-SQLAlchemy<span class="token operator">==</span><span class="token number">2.4</span>.1
Flask-Caching<span class="token operator">==</span><span class="token number">1.4</span>.0
Flask-Migrate<span class="token operator">==</span><span class="token number">2.5</span>.2
Flask-Script<span class="token operator">==</span><span class="token number">2.0</span>.6
<span class="token assign-left variable">SQLAlchemy</span><span class="token operator">==</span><span class="token number">1.3</span>.11
SQLAlchemy-Utils<span class="token operator">==</span><span class="token number">0.36</span>.0
<span class="token assign-left variable">passlib</span><span class="token operator">==</span><span class="token number">1.7</span>.2
<span class="token assign-left variable">bcrypt</span><span class="token operator">==</span><span class="token number">3.1</span>.7
<span class="token assign-left variable">six</span><span class="token operator">==</span><span class="token number">1.13</span>.0
<span class="token assign-left variable">itsdangerous</span><span class="token operator">==</span><span class="token number">1.1</span>.0
requests<span class="token operator">>=</span><span class="token number">2.20</span>.0
<span class="token assign-left variable">PyMySQL</span><span class="token operator">==</span><span class="token number">0.9</span>.3
<span class="token assign-left variable">gunicorn</span><span class="token operator">==</span><span class="token number">19.9</span>.0
<span class="token assign-left variable">normality</span><span class="token operator">==</span><span class="token number">2.0</span>.0
<span class="token assign-left variable">dataset</span><span class="token operator">==</span><span class="token number">1.1</span>.2
<span class="token assign-left variable">mistune</span><span class="token operator">==</span><span class="token number">0.8</span>.4
<span class="token assign-left variable">netaddr</span><span class="token operator">==</span><span class="token number">0.7</span>.19
<span class="token assign-left variable">redis</span><span class="token operator">==</span><span class="token number">3.3</span>.11
<span class="token assign-left variable">datafreeze</span><span class="token operator">==</span><span class="token number">0.1</span>.0
python-dotenv<span class="token operator">==</span><span class="token number">0.10</span>.3
flask-restplus<span class="token operator">==</span><span class="token number">0.13</span>.0
<span class="token assign-left variable">pathlib2</span><span class="token operator">==</span><span class="token number">2.3</span>.5
flask-marshmallow<span class="token operator">==</span><span class="token number">0.10</span>.1
marshmallow-sqlalchemy<span class="token operator">==</span><span class="token number">0.17</span>.0
<span class="token assign-left variable">boto3</span><span class="token operator">==</span><span class="token number">1.10</span>.39
<span class="token assign-left variable">marshmallow</span><span class="token operator">==</span><span class="token number">2.20</span>.2
<span class="token assign-left variable">gevent</span><span class="token operator">==</span><span class="token number">1.4</span>.0
<span class="token assign-left variable">tzlocal</span><span class="token operator">==</span><span class="token number">2.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> nginx
<span class="token builtin class-name">cd</span> nginx
<span class="token function">vim</span> http.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>http.conf的内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">worker_processes <span class="token number">4</span><span class="token punctuation">;</span>
events <span class="token punctuation">&#123;</span>
  worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
http <span class="token punctuation">&#123;</span>
  <span class="token comment"># Configuration containing list of application servers</span>
  upstream app_servers <span class="token punctuation">&#123;</span>
    server ctfd:8000<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  server <span class="token punctuation">&#123;</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    client_max_body_size 4G<span class="token punctuation">;</span>
    <span class="token comment"># Handle Server Sent Events for Notifications</span>
    location /events <span class="token punctuation">&#123;</span>
      proxy_pass http://app_servers<span class="token punctuation">;</span>
      proxy_set_header Connection <span class="token string">''</span><span class="token punctuation">;</span>
      proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
      chunked_transfer_encoding off<span class="token punctuation">;</span>
      proxy_buffering off<span class="token punctuation">;</span>
      proxy_cache off<span class="token punctuation">;</span>
      proxy_redirect off<span class="token punctuation">;</span>
      proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$server_name</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment"># Proxy connections to the application servers</span>
    location / <span class="token punctuation">&#123;</span>
      proxy_pass http://app_servers<span class="token punctuation">;</span>
      proxy_redirect off<span class="token punctuation">;</span>
      proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$server_name</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/CTFd
<span class="token function">docker-compose</span> up -d
<span class="token function">docker</span> network connect --ip <span class="token number">172.1</span>.0.3 ctfd_frp ctfd_frpc_1
<span class="token function">docker</span> network connect --ip <span class="token number">172.1</span>.0.4 ctfd_frp frp-docker-for-ctfd-whale_frps_1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看容器，应该有6个容器，且查看状态STATUS是否是UP。是UP就OK。</p>
<p>在浏览器访问：<a target="_blank" rel="noopener" href="http://ip:8000/">http://ip:8000</a> 即可打开。</p>
<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><p>我尝试了自己写web题目，这就要用到docker的知识。docker里有2个很重要的概念：容器和镜像。容器和镜像类似于对象和类。每道题目实际上是实例化或销毁一个docker镜像。</p>
<p>在 <a target="_blank" rel="noopener" href="https://www.yuque.com/docs/share/364ef08c-9405-45fe-b269-e9236de57242#OE1rs">https://www.yuque.com/docs/share/364ef08c-9405-45fe-b269-e9236de57242?#OE1rs</a> 里发放web题目时有一个<code>Docker Images</code>填写的是ctftraining&#x2F;qwb_2019_supersqil。docker images就是镜像，我们填写的镜像名字是ctftraining&#x2F;qwb_2019_supersqil，但是我们本地没有这个镜像啊，怎么还是创建成功了呢？是因为：</p>
<blockquote>
<p>当运行容器时，使用的镜像如果在本地中不存在，docker 就会自动从 docker 镜像仓库中下载，默认是从 Docker Hub 公共镜像源下载。</p>
</blockquote>
<p>我们可以从Docker Hub网站上查找镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/">Docker Hub Container Image Library | App Containerization</a> </p>
<p>那如何自己出题目，自己创建镜像捏。我查阅了菜鸟教程上docker的知识，懂了大概。</p>
<p>可以利用本地有的镜像，实例化成容器后，使用<code>docker exec -it id /bin/sh</code>命令进入容器，进行web环境的搭建。搭建好后exit退出容器。再使用<code>docker commit id image</code>从已经创建的容器中更新镜像，并且提交这个镜像。最后在发放web题目时docker images填写我们生成的image名字就行了。</p>
<p><em>一些常用命令：</em></p>
<p><strong>容器：</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>docker ps -a</td>
<td>列出所有docker进程，可以查看id、状态……</td>
</tr>
<tr>
<td>docker stop id</td>
<td>关闭指定id的docker进程</td>
</tr>
<tr>
<td>docker start id</td>
<td>开启指定id的docker进程</td>
</tr>
<tr>
<td>docker rm -f id</td>
<td>删除指定id的docker容器</td>
</tr>
<tr>
<td>docker exec -it id &#x2F;bin&#x2F;sh</td>
<td>进入指定id的docker容器</td>
</tr>
<tr>
<td>docker commit id image</td>
<td>从已经创建的容器中更新镜像，并且提交这个镜像</td>
</tr>
</tbody></table>
<p><strong>镜像：</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>docker images</td>
<td>查看所有镜像</td>
</tr>
<tr>
<td>docker run -it name &#x2F;bin&#x2F;sh</td>
<td>实例化镜像</td>
</tr>
<tr>
<td>docker rmi name</td>
<td>删除镜像</td>
</tr>
</tbody></table>
<hr>

  <p><a class="classtest-link" href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a> — 2022年8月30日</p>
  


        </div>
        <div class="row mt-2">
  <h3>Search</h3>
  <div><input id="search-text" title="search" class="search-text" type="text" placeholder="search......"></div>
  <div style="margin-top: 1.5rem;">
    <ul id="result"></ul>
  </div>
</div>
        <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith">Made with ❤ and
        <a class="footer-link icon" href="https://hexo.io" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="Hexo.io">
        <svg class="hexo svg-hov" width="14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Hexo.js</title><path d="M12 .007L1.57 6.056V18.05L12 23.995l10.43-6.049V5.952L12 .007zm4.798 17.105l-.939.521-.939-.521V12.94H9.08v4.172l-.94.521-.938-.521V6.89l.939-.521.939.521v4.172h5.84V6.89l.94-.521.938.521v10.222z"/></svg>
        </a>
        
    </div>

    <!-- Sepcial thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      

      
      <a class="ml-0 footer-link icon" href="https://twitter.com/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Twitter">
        <svg class="twitter svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://instagram.com/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Instagram">
        <svg class="instagram svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Instagram</title><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>
      </a>
      

      

    </div>
  
</div>
<script src="/js/prism/prism.js" async></script>
      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>

  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>